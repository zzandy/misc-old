<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style type="text/css">
    </style>
</head>
<body>
    <script id="2d-vertex" type="x-shader/x-vertex">
        attribute vec2 a_position;
        uniform mat3 u_matrix;

        void main(){
            gl_Position = vec4((u_matrix * vec3(a_position, 1)).xy, 0, 1);
        }
    </script>

    <script id="2d-fragment" type="x-shader/x-fragment">
        void main() {
            gl_FragColor = vec4(0.6,0.0,0.0,1.0);
        }
    </script>

    <script type="text/javascript">

        var iden3 = [1, 0, 0, 0, 1, 0, 0, 0, 1];

        function mul33(a, b) {
            return [
                a[0] * b[0] + a[1] * b[3] + a[2] * b[6],
                a[0] * b[1] + a[1] * b[4] + a[2] * b[7],
                a[0] * b[2] + a[1] * b[5] + a[2] * b[8],

                a[3] * b[0] + a[4] * b[3] + a[5] * b[6],
                a[3] * b[1] + a[4] * b[4] + a[5] * b[7],
                a[3] * b[2] + a[4] * b[5] + a[5] * b[8],

                a[6] * b[0] + a[7] * b[3] + a[8] * b[6],
                a[6] * b[1] + a[7] * b[4] + a[8] * b[7],
                a[6] * b[2] + a[7] * b[5] + a[8] * b[8],
            ];
        }

    </script>

    <script type="text/javascript">
        function trans(x, y) {
            return [
                1, 0, 0,
                0, 1, 0,
                x, y, 1
            ];
        }

        function rot(a) {
            var c = Math.cos(a);
            var s = Math.sin(a);
            return [
                c, -s, 0,
                s, c, 0,
                0, 0, 1
            ];
        }

        function scale(x, y) {
            return [
                x, 0, 0,
                0, y, 0,
                0, 0, 1
            ];
        }

        function proj2d(width, height) {
            return [
                2 / width, 0, 0,
                0, 2 / height, 0,
                -1, -1, 1
            ];
        }

        function makeProjection(width, height, originx, originy, a, sx, sy) {
            var proj = proj2d(width, height);
            var origin = trans(originx, originy);
            var rotation = rot(a);
            var scaling = scale(sx, sy);
            return mul33(mul33(mul33(scaling, rotation), origin), proj);
        }

    </script>

    <script type="text/javascript">
        var mimeFragmentShader = 'x-shader/x-fragment';
        var mimeVertexShader = 'x-shader/x-vertex';

        function compileShader(gl, shaderSource, shaderType) {
            var shader = gl.createShader(shaderType);
            gl.shaderSource(shader, shaderSource);
            gl.compileShader(shader);

            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS))
                throw new Error(gl.getShaderInfoLog(shader));

            return shader;
        }

        function createShader(gl, shaderId) {
            var tag = document.getElementById(shaderId);
            if (!tag)
                throw new Error('Shader script tag ' + shaderId + ' not found.');

            var type = null;

            if (tag.type == mimeFragmentShader)
                type = gl.FRAGMENT_SHADER;
            else if (tag.type == mimeVertexShader)
                type = gl.VERTEX_SHADER;
            else throw new Error('Unknown shader type, expected "' + mimeVertexShader + '" or "' + mimeFragmentShader + '", got "' + tag.type + '"');

            return compileShader(gl, tag.text, type);
        }

        function createProgram(gl, vertex, fragment) {
            var program = gl.createProgram();

            gl.attachShader(program, vertex);
            gl.attachShader(program, fragment);

            gl.linkProgram(program);

            if (!gl.getProgramParameter(program, gl.LINK_STATUS))
                throw new Error(gl.getProgramInfoLog(program));

            return program;
        }

        function createProgramFromScripts(gl, vertexId, fragmentId) {
            var vertex = createShader(gl, vertexId);
            var fragment = createShader(gl, fragmentId);

            return createProgram(gl, vertex, fragment);
        }
    </script>

    <script type="text/javascript">

        var origin = [100,100];
        var scaling = [1, 1];
        var a = 0;

        function makeCanvas() {
            var canvas = document.createElement('canvas');
            canvas.width = document.body.parentElement.clientWidth;
            canvas.height = document.body.parentElement.clientHeight;
            canvas.style.position = 'absolute';
            canvas.style.top = '0';
            canvas.style.left = '0';

            document.body.appendChild(canvas);
            return canvas;
        }

        function makeGeometry(w) {
            return new Float32Array([
                0, 0,
                w, 0,
                w, 7 * w,

                w, 7 * w,
                0, 7 * w,
                0, 0,

                 w, 3 * w,
                 3 * w, 3 * w,
                 3 * w, 4 * w,

                 3 * w, 4 * w,
                 w, 4 * w,
                 w, 3 * w,

                 w, 6 * w,
                 4 * w, 6 * w,
                 4 * w, 7 * w,

                 4 * w, 7 * w,
                 w, 7 * w,
                 w, 6 * w
            ]);
        }
        
        function init() {
            var canvas = makeCanvas();
            var gl = canvas.getContext('experimental-webgl');
            gl.clearColor(1, 1, 1, 1);

            var program = createProgramFromScripts(gl, '2d-vertex', '2d-fragment');
            gl.useProgram(program);

            var pos = gl.getAttribLocation(program, 'a_position');
            var matrix = gl.getUniformLocation(program, 'u_matrix');

            var buffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, makeGeometry(10), gl.STATIC_DRAW);

            gl.enableVertexAttribArray(pos);
            gl.vertexAttribPointer(pos, 2, gl.FLOAT, false, 0, 0);

            return function () {
                var proj = makeProjection(canvas.clientWidth, canvas.clientHeight, origin[0], origin[1], a, scaling[0], scaling[1])
                gl.uniformMatrix3fv(matrix, false, proj);

                gl.clear(gl.COLOR_BUFFER_BIT);
                gl.drawArrays(gl.TRIANGLES, 0, 18);
            }
        }

        var draw = init('canvas');

        var k = 0;

        var time = (new Date()).getTime();

        var numframes = 50;
        var framecounters = new Array(numframes)
        var frameno = 0;
        for (var i = 0; i < numframes; ++i) framecounters[i] = 0;

        window.setInterval(function () {
            var frametime = framecounters.reduce(function (a, b) { return a + b }) / framecounters.length
            var fps = (100000 / frametime | 0) / 100;
            console.log(frametime, fps);
        },
            500);

        function tick() {

            var time2 = (new Date()).getTime();
            framecounters[frameno++] = time2-time; 
            time = time2;
             

            if (frameno >= numframes) frameno = 0;

            a += .01;
            k += Math.PI/7;

            scaling = [
                1+  .8*Math.cos(k), 1+ .8*Math.cos(k + .5)
            ];
            draw();

            //window.requestAnimationFrame(tick);
        }

        tick();
    </script>
</body>
</html>