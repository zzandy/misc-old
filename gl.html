<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <style type="text/css">
    </style>
</head>
<body>
    <script id="vertex" type="x-shader/x-vertex">
        attribute vec4 a_position;
        attribute vec4 a_color;
        uniform mat4 u_matrix;
        varying vec4 v_color;

        void main(){
            gl_Position = u_matrix * a_position;
            v_color = a_color;
        }
    </script>

    <script id="fragment" type="x-shader/x-fragment">
        precision highp float;
        varying vec4 v_color;

        void main() {
            gl_FragColor = v_color;
        }
    </script>

    <script type="text/javascript">

        var iden3 = [1, 0, 0, 0, 1, 0, 0, 0, 1];
        var iden4 = [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1];

        function mul33(a, b) {
            return [
                a[0] * b[0] + a[1] * b[3] + a[2] * b[6],
                a[0] * b[1] + a[1] * b[4] + a[2] * b[7],
                a[0] * b[2] + a[1] * b[5] + a[2] * b[8],

                a[3] * b[0] + a[4] * b[3] + a[5] * b[6],
                a[3] * b[1] + a[4] * b[4] + a[5] * b[7],
                a[3] * b[2] + a[4] * b[5] + a[5] * b[8],

                a[6] * b[0] + a[7] * b[3] + a[8] * b[6],
                a[6] * b[1] + a[7] * b[4] + a[8] * b[7],
                a[6] * b[2] + a[7] * b[5] + a[8] * b[8],
            ];
        }

        function mul44(a, b) {
            return [
                a[0] * b[0] + a[1] * b[4] + a[2] * b[8] + a[3] * b[12],
                a[0] * b[1] + a[1] * b[5] + a[2] * b[9] + a[3] * b[13],
                a[0] * b[2] + a[1] * b[6] + a[2] * b[10] + a[3] * b[14],
                a[0] * b[3] + a[1] * b[7] + a[2] * b[11] + a[3] * b[15],

                a[4] * b[0] + a[5] * b[4] + a[6] * b[8] + a[7] * b[12],
                a[4] * b[1] + a[5] * b[5] + a[6] * b[9] + a[7] * b[13],
                a[4] * b[2] + a[5] * b[6] + a[6] * b[10] + a[7] * b[14],
                a[4] * b[3] + a[5] * b[7] + a[6] * b[11] + a[7] * b[15],

                a[8] * b[0] + a[9] * b[4] + a[10] * b[8] + a[11] * b[12],
                a[8] * b[1] + a[9] * b[5] + a[10] * b[9] + a[11] * b[13],
                a[8] * b[2] + a[9] * b[6] + a[10] * b[10] + a[11] * b[14],
                a[8] * b[3] + a[9] * b[7] + a[10] * b[11] + a[11] * b[15],

                a[12] * b[0] + a[13] * b[4] + a[14] * b[8] + a[15] * b[12],
                a[12] * b[1] + a[13] * b[5] + a[14] * b[9] + a[15] * b[13],
                a[12] * b[2] + a[13] * b[6] + a[14] * b[10] + a[15] * b[14],
                a[12] * b[3] + a[13] * b[7] + a[14] * b[11] + a[15] * b[15],
            ];
        }

        function inverse(m) {
            var m00 = m[0 * 4 + 0];
            var m01 = m[0 * 4 + 1];
            var m02 = m[0 * 4 + 2];
            var m03 = m[0 * 4 + 3];
            var m10 = m[1 * 4 + 0];
            var m11 = m[1 * 4 + 1];
            var m12 = m[1 * 4 + 2];
            var m13 = m[1 * 4 + 3];
            var m20 = m[2 * 4 + 0];
            var m21 = m[2 * 4 + 1];
            var m22 = m[2 * 4 + 2];
            var m23 = m[2 * 4 + 3];
            var m30 = m[3 * 4 + 0];
            var m31 = m[3 * 4 + 1];
            var m32 = m[3 * 4 + 2];
            var m33 = m[3 * 4 + 3];
            var tmp_0 = m22 * m33;
            var tmp_1 = m32 * m23;
            var tmp_2 = m12 * m33;
            var tmp_3 = m32 * m13;
            var tmp_4 = m12 * m23;
            var tmp_5 = m22 * m13;
            var tmp_6 = m02 * m33;
            var tmp_7 = m32 * m03;
            var tmp_8 = m02 * m23;
            var tmp_9 = m22 * m03;
            var tmp_10 = m02 * m13;
            var tmp_11 = m12 * m03;
            var tmp_12 = m20 * m31;
            var tmp_13 = m30 * m21;
            var tmp_14 = m10 * m31;
            var tmp_15 = m30 * m11;
            var tmp_16 = m10 * m21;
            var tmp_17 = m20 * m11;
            var tmp_18 = m00 * m31;
            var tmp_19 = m30 * m01;
            var tmp_20 = m00 * m21;
            var tmp_21 = m20 * m01;
            var tmp_22 = m00 * m11;
            var tmp_23 = m10 * m01;

            var t0 = (tmp_0 * m11 + tmp_3 * m21 + tmp_4 * m31) -
                (tmp_1 * m11 + tmp_2 * m21 + tmp_5 * m31);
            var t1 = (tmp_1 * m01 + tmp_6 * m21 + tmp_9 * m31) -
                (tmp_0 * m01 + tmp_7 * m21 + tmp_8 * m31);
            var t2 = (tmp_2 * m01 + tmp_7 * m11 + tmp_10 * m31) -
                (tmp_3 * m01 + tmp_6 * m11 + tmp_11 * m31);
            var t3 = (tmp_5 * m01 + tmp_8 * m11 + tmp_11 * m21) -
                (tmp_4 * m01 + tmp_9 * m11 + tmp_10 * m21);

            var d = 1.0 / (m00 * t0 + m10 * t1 + m20 * t2 + m30 * t3);

            return [
              d * t0,
              d * t1,
              d * t2,
              d * t3,
              d * ((tmp_1 * m10 + tmp_2 * m20 + tmp_5 * m30) -
                    (tmp_0 * m10 + tmp_3 * m20 + tmp_4 * m30)),
              d * ((tmp_0 * m00 + tmp_7 * m20 + tmp_8 * m30) -
                    (tmp_1 * m00 + tmp_6 * m20 + tmp_9 * m30)),
              d * ((tmp_3 * m00 + tmp_6 * m10 + tmp_11 * m30) -
                    (tmp_2 * m00 + tmp_7 * m10 + tmp_10 * m30)),
              d * ((tmp_4 * m00 + tmp_9 * m10 + tmp_10 * m20) -
                    (tmp_5 * m00 + tmp_8 * m10 + tmp_11 * m20)),
              d * ((tmp_12 * m13 + tmp_15 * m23 + tmp_16 * m33) -
                    (tmp_13 * m13 + tmp_14 * m23 + tmp_17 * m33)),
              d * ((tmp_13 * m03 + tmp_18 * m23 + tmp_21 * m33) -
                    (tmp_12 * m03 + tmp_19 * m23 + tmp_20 * m33)),
              d * ((tmp_14 * m03 + tmp_19 * m13 + tmp_22 * m33) -
                    (tmp_15 * m03 + tmp_18 * m13 + tmp_23 * m33)),
              d * ((tmp_17 * m03 + tmp_20 * m13 + tmp_23 * m23) -
                    (tmp_16 * m03 + tmp_21 * m13 + tmp_22 * m23)),
              d * ((tmp_14 * m22 + tmp_17 * m32 + tmp_13 * m12) -
                    (tmp_16 * m32 + tmp_12 * m12 + tmp_15 * m22)),
              d * ((tmp_20 * m32 + tmp_12 * m02 + tmp_19 * m22) -
                    (tmp_18 * m22 + tmp_21 * m32 + tmp_13 * m02)),
              d * ((tmp_18 * m12 + tmp_23 * m32 + tmp_15 * m02) -
                    (tmp_22 * m32 + tmp_14 * m02 + tmp_19 * m12)),
              d * ((tmp_22 * m22 + tmp_16 * m02 + tmp_21 * m12) -
                    (tmp_20 * m12 + tmp_23 * m22 + tmp_17 * m02))
            ];
        }


    </script>

    <!-- 3d transformations -->
    <script type="text/javascript">

        function translate3d(trans) {
            return [
                1, 0, 0, 0,
                0, 1, 0, 0,
                0, 0, 1, 0,
                trans[0], trans[1], trans[2], 1
            ];
        }

        function scale3d(scale) {
            return [
                scale[0], 0, 0, 0,
                0, scale[1], 0, 0,
                0, 0, scale[2], 0,
                0, 0, 0, 1
            ];
        }

        function vectorAngleQuaternion(v, a) {
            var s = Math.sin(a / 2);
            return [s * v[0], s * v[1], s * v[2], Math.cos(a / 2)];
        }

        function rotate3d(q) {
            var x = q[0];
            var y = q[1];
            var z = q[2];
            var w = q[3];

            return [
                1 - 2 * y * y - 2 * z * z, 2 * x * y - 2 * z * w, 2 * x * z + 2 * y * w, 0,
                2 * x * y + 2 * z * w, 1 - 2 * x * x - 2 * z * z, 2 * y * z - 2 * x * w, 0,
                2 * x * z - 2 * y * w, 2 * y * z + 2 * x * w, 1 - 2 * x * x - 2 * y * y, 0,
                0, 0, 0, 1
            ];
        }

        function makePerspective(fov, aspect, near, far) {
            var f = Math.tan((Math.PI - fov) / 2);
            var r = 1 / (near - far);

            return [
                f / aspect, 0, 0, 0,
                0, f, 0, 0,
                0, 0, (near + far) * r, -1,
                0, 0, near * far* r * 2, 0
            ];
        }


        function makeProjection3d(view, proj, origin, rv, ra, scales) {
            var scale = scale3d(scales);
            var rot = rotate3d(vectorAngleQuaternion(rv, ra));
            var translate = translate3d(origin);

            return mul44(mul44(mul44(mul44(scale, rot), translate), view), proj);
        }

        function cross(a, b) {
            return [a[1] * b[2] - a[2] * b[1],
                a[2] * b[0] - a[0] * b[2],
                a[0] * b[1] - a[1] * b[0]];
        }

        var epsilon = 1e-10;
        var tau = 2 * Math.PI;
        var deg = tau / 360;
        qua
        function length(a) {
            return Math.sqrt(a[0] * a[0] + a[1] * a[1] + a[2] * a[2]);
        }

        function substract(a, b) {
            return [a[0] - b[0], a[1] - b[1], a[2] - b[2]];
        }

        function norm(a) {
            var len = length(a);
            return len > epsilon
                ? [a[0] / len, a[1] / len, a[2] / len]
                : [0, 0, 0];
        }

        function lookAt(pos, target, up) {
            var z = norm(substract(pos, target))
            var x = cross(up, z);
            var y = cross(z, x);

            return [
                x[0], x[1], x[2], 0,
                y[0], y[1], y[2], 0,
                z[0], z[1], z[2], 0,
                pos[0], pos[1], pos[2], 1
            ];
        }

    </script>

    <!-- shader loading -->
    <script type="text/javascript">
        var mimeFragmentShader = 'x-shader/x-fragment';
        var mimeVertexShader = 'x-shader/x-vertex';

        function compileShader(gl, shaderSource, shaderType) {
            var shader = gl.createShader(shaderType);
            gl.shaderSource(shader, shaderSource);
            gl.compileShader(shader);

            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS))
                throw new Error(gl.getShaderInfoLog(shader));

            return shader;
        }

        function createShader(gl, shaderId) {
            var tag = document.getElementById(shaderId);
            if (!tag)
                throw new Error('Shader script tag ' + shaderId + ' not found.');

            var type = null;

            if (tag.type == mimeFragmentShader)
                type = gl.FRAGMENT_SHADER;
            else if (tag.type == mimeVertexShader)
                type = gl.VERTEX_SHADER;
            else throw new Error('Unknown shader type, expected "' + mimeVertexShader + '" or "' + mimeFragmentShader + '", got "' + tag.type + '"');

            return compileShader(gl, tag.text, type);
        }

        function createProgram(gl, vertex, fragment) {
            var program = gl.createProgram();

            gl.attachShader(program, vertex);
            gl.attachShader(program, fragment);

            gl.linkProgram(program);

            if (!gl.getProgramParameter(program, gl.LINK_STATUS))
                throw new Error(gl.getProgramInfoLog(program));

            return program;
        }

        function createProgramFromScripts(gl, vertexId, fragmentId) {
            var vertex = createShader(gl, vertexId);
            var fragment = createShader(gl, fragmentId);

            return createProgram(gl, vertex, fragment);
        }
    </script>

    <!-- helpers -->
    <script type="text/javascript">
        function makeCanvas() {
            var canvas = document.createElement('canvas');
            canvas.width = document.body.parentElement.clientWidth;
            canvas.height = document.body.parentElement.clientHeight;
            canvas.style.position = 'absolute';
            canvas.style.top = '0';
            canvas.style.left = '0';

            document.body.appendChild(canvas);
            return canvas;
        }

        function makeBox(x, y, z, w, hy, dz) {

            var a = [x, y, z];
            var b = [x + w, y, z];
            var c = [x + w, y, z - dz];
            var d = [x, y, z - dz];
            var e = [x, y + hy, z];
            var f = [x + w, y + hy, z];
            var g = [x + w, y + hy, z - dz];
            var h = [x, y + hy, z - dz];

            function tri(a, b, c) {
                return a.concat(b, c);
            }

            function quad(a, b, c, d) {
                return tri(a, b, c).concat(tri(c, d, a));
            }

            var x = [].concat(
                quad(a, b, c, d),
                quad(a, e, f, b),
                quad(f, g, c, b),
                quad(g, h, d, c),
                quad(h, e, a, d),
                quad(h, g, f, e)
                );

            return x;
        }

        function makeGeometry(w) {

            return new Float32Array(
                    [].concat(
                    makeBox(0, 0, 0, w, 6 * w, w),
                    makeBox(w, 3 * w, 0, 2 * w, w, w),
                    makeBox(0, 6 * w, 0, 4 * w, w, w),

                    makeBox(2 * w, 8 * w, 0, w, w, 2 * w)
                ));
        }

        function makeColors(geometry) {
            var colors = [];

            var a = Math.random() * 360;
            var b = 20 + Math.random() * 320;
            var side = hcy(a, 1, .5);
            var face = hcy((a + b) % 360, 1, .5);
            var cls = [side, side, face, face, side, side, face, face, side, side, side, side];

            for (var i = 0; i < geometry.length / 3; ++i) {
                var c = hcy2rgb(Math.random() * 360, 1, .5);
                c = cls[i % cls.length];
                colors = colors.concat(c.concat(c, c));
            }

            return colors;
        }

    </script>

    <!-- Color -->
    <script type="text/javascript">

        // hue Chroma luma
        function hcy2rgb(h, c, y, a) {
            // 601
            var r = .3;
            var g = .59;
            var b = .11;

            var h0 = h;
            h /= 60;

            var k = (1 - Math.abs((h % 2) - 1));

            var K = h < 1 ? r + k * g
                : h < 2 ? g + k * r
                : h < 3 ? g + k * b
                : h < 4 ? b + k * g
                : h < 5 ? b + k * r
                : r + k * b;

            var cmax = 1;

            if (y <= 0 || y >= 1) cmax = 0;
            else cmax *= K < y ? (y - 1) / (K - 1) : K > y ? y / K : 1;
            c = Math.min(c, cmax);

            var x = c * k;
            var rgb = h < 1 ? [c, x, 0]
                : h < 2 ? [x, c, 0]
                : h < 3 ? [0, c, x]
                : h < 4 ? [0, x, c]
                : h < 5 ? [x, 0, c]
                : [c, 0, x];

            var m = y - (r * rgb[0] + g * rgb[1] + b * rgb[2]);

            var rgbdata = [rgb[0] + m, rgb[1] + m, rgb[2] + m];

            return rgbdata;
        }

        function hcy(h,c,y) {

            var k = .1;
            var x = h / 360;
            ha = h * (1 - (x < .66 ? 1 : 0) * k * Math.sin(3 * Math.PI * x));
            y *= (1 + .4 * Math.sin(x * 2 * Math.PI));

            return hcy2rgb(ha,c,y);
        }

    </script>

    <script type="text/javascript">

        var a = 0;
        var xxxa = 0;

        function init() {
            var canvas = makeCanvas();
            var gl = canvas.getContext('experimental-webgl');
            gl.clearColor(1, 1, 1, 1);

            var program = createProgramFromScripts(gl, 'vertex', 'fragment');
            gl.useProgram(program);
            gl.enable(gl.CULL_FACE);
            gl.enable(gl.DEPTH_TEST);

            var pos = gl.getAttribLocation(program, 'a_position');
            var matrix = gl.getUniformLocation(program, 'u_matrix');
            var color = gl.getAttribLocation(program, 'a_color');

            var geometry = makeGeometry(10);
            var colors = makeColors(geometry);

            var buffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, geometry, gl.STATIC_DRAW);

            gl.enableVertexAttribArray(pos);
            gl.vertexAttribPointer(pos, 3, gl.FLOAT, false, 0, 0);

            buffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colors), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(color);
            gl.vertexAttribPointer(color, 3, gl.FLOAT, false, 0, 0);

            var fov = 95 * deg;
            var aspect = canvas.clientWidth / canvas.clientHeight;

            return function () {
                var cam = [20, -50, 100];
                var lookat = [0, 0, 0];
                var up = [0, 0,1];
                var or = [0, 0, 0];
                var sc = [1, 1, -1];
                var rv = [0, 0, 1];
                var ra = a;

                var pr = makePerspective(fov, aspect, 1, 1000);
                var view = inverse(lookAt(cam, lookat, up));
                var proj = makeProjection3d(view, pr, or, rv, ra, sc);

                gl.uniformMatrix4fv(matrix, false, proj);

                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                gl.drawArrays(gl.TRIANGLES, 0, geometry.length / 3);
            }
        }

        var draw = init('canvas');

        var k = 0;

        var time = (new Date()).getTime();

        var numframes = 50;
        var framecounters = new Array(numframes)
        var frameno = 0;
        for (var i = 0; i < numframes; ++i) framecounters[i] = 0;

        window.setInterval(function () {
            var frametime = framecounters.reduce(function (a, b) { return a + b }) / framecounters.length
            var fps = (100000 / frametime | 0) / 100;
            console.log(frametime, fps);
        },
            100000);

        function tick() {

            var time2 = (new Date()).getTime();
            framecounters[frameno++] = time2-time;
            time = time2;

            if (frameno >= numframes) frameno = 0;

            xxxa += .008;
            a += .01;
            k += Math.PI/7;

            scaling = [
                1 + .8 * Math.cos(k), 1 + .8 * Math.cos(k + .5)
            ];
            draw();

            window.requestAnimationFrame(tick);
        }

        tick();
    </script>
</body>
</html>