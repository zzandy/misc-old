<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8" />
    <title>Audio</title>
</head>

<body>

    <label><input name="mute" type="checkbox" />Mute</label>
    <label><input name="saw" type="radio" value="sine" />Sine</label>
    <label><input name="saw" type="radio" value="sawtooth" />Saw</label>
    <label><input name="saw" type="radio" value="square" />Square</label>
    <label><input name="saw" type="radio" value="triangle" />Triangle</label>

    <script type="text/javascript">
        const ctx = new AudioContext();

        const oscillator = ctx.createOscillator();
        const oscillator2 = ctx.createOscillator();
        const gainNode = ctx.createGain();
        const filter = ctx.createBiquadFilter();

        bindRadial('saw', function (value) { oscillator.type = value });
        document.getElementsByName('mute')[0].addEventListener('change', function(e){if(e.target.checked)gainNode.gain.value = 0;else gainNode.gain.value=1; });

        connect(oscillator, filter, gainNode, ctx.destination);
        connect(oscillator2, filter, gainNode, ctx.destination);

        oscillator.type = 'sine';
        oscillator.frequency.value = 440;
        oscillator.start();

        oscillator2.type = 'sine';
        oscillator2.frequency.value = 440;
        oscillator2.start();


        filter.type = "lowshelf";
        filter.frequency.value = 40;
        filter.gain.value = 25;

        function Loop(callback) {
            this.isRunning = false;
            this.callback = callback;
            this.last = 0;
        }

        Loop.prototype.start = function () {
            this.isRunning = true;
            this.last = 0;
            const self = this;

            const frame = function (x) {
                self.callback(x - self.last);
                self.last = x;
                if (self.isRunning)
                    requestAnimationFrame(frame);
            }

            requestAnimationFrame(frame);

            return this;
        }


        var acc = 0;
        const delay = 200;
        function nextFrequency() {
            let n = 0;
            const maxn = 24;
            const cent = 1.05946309435929;
            let freq = 440;
            nextFrequency = function () {
                if (++n > maxn) {
                    freq = 220;
                    n = 0;
                }
                else {
                    freq *= cent;
                    freq *= cent;
                }
                return freq;
            }

            return nextFrequency();
        }

        const loop = new Loop(function (delta) {
            acc += delta;
            if (acc > delay) {
                acc -= delay;
                oscillator.frequency.value = nextFrequency();
            }
        }).start();


        function bindRadial(name, setter) {
            for (const element of document.getElementsByName(name)) {
                if (element.checked) setter(element.value);
                element.addEventListener('click', function (e) {
                    setter(element.value);
                });
            }
        }

        function connect() {
            var prev = arguments[0];
            for (var i = 1; i < arguments.length; ++i) {
                const next = arguments[i];
                prev.connect(next);
                prev = next;
            }
        }
    </script>
</body>

</html>