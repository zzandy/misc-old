<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8" />
    <title>Circles</title>
    <style type="text/css">
        html,
        body {
            background-color: #232220;
            color: #dad6d0;
            font-size: 14pt;
        }
    </style>
</head>

<body>
    <div style="position: fixed; z-index: 10;">
        <div>
            <label>Width:
                <input id="w" type="range" min="2" max="24" value="12" />
            </label>
            <label>Height:
                <input id="h" type="range" min="1" max="24" value="12" />
            </label>
        </div>

        <div>
            <label>Square:
                <span id="square"></span>
            </label>
        </div>

        <div>
            <label>Hex:
                <span id="hex"></span>
            </label>
        </div>
    </div>

    <script type="text/javascript">
        (function () {
            document.createElement('canvas');
            var c = document.createElement('canvas');
            ctx = c.getContext('2d');

            ctx.w = ctx.canvas.width = window.innerWidth;
            ctx.h = ctx.canvas.height = window.innerHeight;
            ctx.canvas.style.position = 'absolute';
            ctx.canvas.style.top = 0;
            ctx.canvas.style.left = 0;

            document.body.appendChild(c);
        })();
    </script>

    <script type="text/javascript">
        const tau = Math.PI * 2;

        CanvasRenderingContext2D.prototype.fillCircle = function (x, y, r) {
            this.beginPath();
            this.arc(x, y, r, 0, tau, false)
            this.closePath();
            this.fill();
        }

        CanvasRenderingContext2D.prototype.strokeCircle = function (x, y, r) {
            this.beginPath();
            this.arc(x, y, r, 0, tau, false)
            this.closePath();
            this.stroke();
        }
    </script>

    <script type="text/javascript">

        const palette = {
            plate: { border: 'silver', background: 'transparent' },
            extraSpace: { border: 'transparent', background: 'silver' },
            circle: { border: 'silver', background: 'transparent' },
            circleGained: { border: 'lime', background: 'transparent' },
            circleLost: { border: 'red', background: 'transparent' },
        }

        main();

        function main() {
            ['w', 'h'].map(id => document.getElementById(id)).forEach(e => {
                e.addEventListener('input', updateSize);
            });
            updateSize();
        }

        function updateSize() {
            render.apply(null, 'w,h'.split(',').map(id => parseInt(document.getElementById(id).value, 10)));
        }

        function render(w, h) {
            const width = ctx.canvas.width;
            const height = ctx.canvas.height;

            const pad = width * .03;

            const rw = (width - 3 * pad) / 2;
            const rh = height - 2 * pad;

            const sar = w / h;
            const tar = rw / rh;

            const s = sar > tar ? rw / w : rh / h;

            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            const oy = height / 2 - s * h / 2;

            ctx.save();
            ctx.translate(pad, oy);

            renderSquarePacking(ctx, s, w, h);

            ctx.restore();

            const mar = pad * 2 + w * s;

            ctx.save();
            ctx.translate(mar, oy);

            renderHexPacking(ctx, s, w, h);

            ctx.restore();
        }

        function renderHexPacking(ctx, s, w, h) {
            const sq32 = Math.sqrt(3) / 2;

            drawRect(ctx, palette.plate, 0, 0, s * w, s * h);

            let i = 0;
            let j = 0;

            let n = w * h;
            let extra = 0;

            let activePlette = palette.circle;
            while (true) {
                if (i >= w - j % 2) {
                    j += 1;

                    i = 0;
                }

                n--;

                let y = s * j * sq32 + s / 2;

                if (n < 0 && j * sq32 + 1 > h) {

                    if (extra >= 0) {
                        let edge = y - s * sq32 + s / 2;
                        drawRect(ctx, palette.extraSpace, 0, edge, s * w, s * h - edge);
                    }
                    break;
                }

                if (j * sq32 + 1 > h) extra--;

                if (extra < 0)
                    activePlette = palette.circleLost;

                drawCircle(ctx, activePlette, s / 2 + j % 2 * s / 2 + s * i, y, s / 2);
                ++i;

                if (n == 0) {
                    activePlette = palette.circleGained;
                }
                if (n < 0) extra++;

            }

            document.getElementById('square').innerHTML = w * h;
            document.getElementById('hex').innerHTML = (w * h + extra) + ' = ' + w * h + ' ' + (extra > 0 ? '+' : '-') + ' ' + Math.abs(extra);
        }

        function renderSquarePacking(ctx, s, w, h) {
            drawRect(ctx, palette.plate, 0, 0, s * w, s * h);

            for (let i = 0; i < w; ++i) {
                for (let j = 0; j < h; ++j) {
                    drawCircle(ctx, palette.circle, i * s + s / 2, s * j + s / 2, s / 2);
                }
            }
        }

        function drawRect(ctx, palette, x, y, w, h) {
            ctx.strokeStyle = palette.border;
            ctx.fillStyle = palette.background;

            ctx.fillRect(x, y, w, h);
            ctx.strokeRect(x, y, w, h);
        }

        function drawCircle(ctx, palette, x, y, r) {
            ctx.strokeStyle = palette.border;
            ctx.fillStyle = palette.background;

            ctx.fillCircle(x, y, r);
            ctx.strokeCircle(x, y, r);
        }
    </script>
</body>

</html>