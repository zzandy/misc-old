<!DOCTYPE html>
<html>
<head>
    <title>---</title>
</head>
<body>

    <script type="text/javascript">

    (function(global){
        'use strict';

        global.makeLoop = function(fixedDelta, fixedUpdate, update){
            var acc = 0;

            return function(delta){
                if(delta === undefined || isNaN(delta)){
                    delta = fixedDelta;
                }

                acc += delta;

                while(acc>=fixedDelta){
                    fixedUpdate(fixedDelta);
                    acc -= fixedDelta;
                }
                update(delta);
            }
        }

        global.loop = function(loopFunction, sheduleFunction){

            var then;
            var iteration = function(){
                var now = new Date().getTime();
                var delta = now - then;
                then = now;

                loopFunction(delta);

                sheduleFunction(iteration);
            }

            iteration();
        }
    }(this));

</script>

    <script type="text/javascript">

        (function(global){
            'use strict';

            global.fullscreenCanvas = function() {

                var c = document.createElement('canvas');
                var ctx = c.getContext('2d');

                ctx.canvas.width = window.innerWidth;
                ctx.canvas.height = window.innerHeight;
                ctx.canvas.style.position = 'absolute';
                ctx.canvas.style.top = 0;
                ctx.canvas.style.left = 0;

                ctx.clear = function(){
                    ctx.clearRect(-ctx.canvas.width/2, -ctx.canvas.height/2, ctx.canvas.width, ctx.canvas.height);
                };

                var q = 1 / Math.sqrt(3);

                ctx.getHexPath = function(h){
                    var dx = q * h / 2;
                    var dy = h / 2;

                    return [2 * dx, 0
                            ,dx, -dy
                            ,-dx, -dy
                            ,-2 * dx, 0
                            ,-dx, dy
                            ,dx, dy];
                }

                ctx.makePath = function(vertices){
                    this.beginPath();
                    this.moveTo(vertices[0], vertices[1]);
                    for(var i=2;i<vertices.length;i+=2){
                        this.lineTo(vertices[i], vertices[i+1]);
                    }
                    this.closePath();
                }

                ctx.pathHex = function (h) {
                    this.makePath(this.getHexPath(h));
                };

                ctx.fillHex = function (x, y, h) {
                    this.save();
                    this.translate(x, y);
                    this.pathHex(h);
                    this.fill();
                    this.restore();
                };

                ctx.strokeHex = function (x, y, a) {
                    this.save();
                    this.translate(x, y);
                    this.pathHex(a);
                    this.stroke();
                    this.restore();
                };

                ctx.translate(ctx.canvas.width / 2, ctx.canvas.height / 2);
                document.body.appendChild(c);
                return ctx;
            }
        }(this));

    </script>

    <script type="text/javascript">

        (function(global){
            "use strict";

        function Field(mi, mj, makeCell){
            var body = [];

            for(var i=0;i<mi;++i){
                var row = [];
                for(var j=0;j<mj;++j){
                    row.push(makeCell(i, j));
                }
                body.push(row);
            }

            this.body = body;
        }

        Field.prototype.forEach = function(processCell){
            for(var i=0;i<this.body.length;++i)
                for(var j=0;j<this.body[i].length;++j)
                    if(this.body[i][j] !== null)
                        processCell(i, j, this.body[i][j]);
        }

        Field.prototype.evolve = function(processCell){
            var body = [];

            for(var i=0;i<this.body.length;++i){
                var row = [];

                for(var j=0;j<this.body[i].length;++j){
                    var cell = this.body[i][j];
                    row.push(cell === null ? null : processCell(i, j, cell));
                }

                body.push(row);
            }

            this.body = body;
        }

        global.Field = Field;

        }(this));

    </script>

    <script type="text/javascript">

        (function(global){
            "use strict";

            function SuperCell(rank){
                if(rank < 1)
                    throw new Error('SuperCell rank cannot be less than 1');

                this.rank = rank;
            }

            function getDimension(){
                return 4 * this.rank + 1;
            }

            Object.defineProperty(SuperCell.prototype, 'width', {get: getDimension});
            Object.defineProperty(SuperCell.prototype, 'height', {get: getDimension});

            SuperCell.prototype.contains = function(i, j){
                var r = this.rank;

                var h2 = r * 2;

                var a = 8*r + 1;
                var b = 6*r + 1;
                var c = 4*r - 1;

                return j*2   - i + h2-(a + b)/2   <= 0
                    && j*2   - i + h2-(a - b)/2   >= 0
                    && j*1/2 - i + h2 - (c + b)/4 <= 0
                    && j*1/2 - i + h2 - (c - b)/4 >= 0
                    && j*-1  - i + h2 + (c + b)/2 >= 0
                    && j*-1  - i + h2 + (c - b)/2 <= 0;
            }

            global.SuperCell = SuperCell;
        }(this));

    </script>

    <script type="text/javascript">

        var sq32 = Math.sqrt(3) / 2;
        var tau = 2*Math.PI;

        function hexToPix(i, j, h) {
            return [
                h * (j) * sq32,
                -h * (i - j / 2) + h/4
            ];
        }

        function rnd(){
            switch(arguments.length){
                case 0:
                    return Math.random();
                case 1:
                    if(arguments[0] instanceof Array)
                        return arguments[0][Math.floor(Math.random()*arguments[0].length)];
                    else return arguments[0] * Math.random();
            }
        }

        var w = 5;
        var h = 5;



        function getGenerator(sc, colors){
            return function(i,j){
                return sc.contains(i, j)
                    ? rnd(colors)
                    : null;
            }
        }

        var colors = ["rgb(255,40,20)", "rgb(153,153,153)", "rgb(238,139,0)", "rgb(139,167,0)", "rgb(0,185,169)", "rgb(94,121,255)", "rgb(207,0,248)"];

        var ctx = fullscreenCanvas();

        var sc = new SuperCell(2);
        var fld = new Field(sc.width, sc.height, getGenerator(sc, colors)); 
        var ijorigin = sc.rank*2+1;

        function render(i, j, cell){
            var s = 30;
            var pos = hexToPix(i-ijorigin, j-ijorigin, s);
            var x = pos[0], y = pos[1];

            ctx.save();
            ctx.translate(x, y)
            ctx.fillStyle = cell;
            ctx.fillHex(0,0,s);

            ctx.fillStyle = ctx.createLinearGradient(0, s/2, 0, -s/2);
            ctx.fillStyle.addColorStop(1, 'rgba(255,255,255, .4)');
            ctx.fillStyle.addColorStop(.8, 'rgba(255,255,255,0)');
            ctx.fillStyle.addColorStop(.6, 'rgba(255,255,255,0)');
            ctx.fillStyle.addColorStop(.1, 'rgba(255,255,255, .4)');
            ctx.fillStyle.addColorStop(0, 'rgba(255,255,255,.2)');

            ctx.globalCompositeOperation = 'screen';
            ctx.fillHex(0,0,s*1.01);

            ctx.fillStyle = ctx.createLinearGradient(0, .7*s/2, 0, .7*-s/2);
            ctx.fillStyle.addColorStop(1, 'rgba(255,255,255, .4)');
            ctx.fillStyle.addColorStop(0, 'rgba(255,255,255,0)');
            ctx.fillHex(0,0,.7*s);

            ctx.restore();
        }

        loop(makeLoop(20, fixedUpdate, update), window.requestAnimationFrame);

        var phase = 0;
        var firstFixedUpdate = true;

        function fixedUpdate(delta){
            if(firstFixedUpdate || firstUpdate){
                console.log('fixed', delta);
                firstFixedUpdate=false;
            }

            //fld.evolve(function(i, j, cell){
            //    return rnd() < .001
            //        ? rnd(['gold', 'teal', 'maroon'])
            //        : cell;
            //});
        }

        var firstUpdate = true;
        function update(delta){
            if(firstUpdate){
                console.log('update', delta);
                firstUpdate=false;
            }

            ctx.clear();
            fld.forEach(render);
        }

    </script>

</body>
</html>