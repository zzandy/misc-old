<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8" />
    <title>Cell</title>
</head>

<body>
    <script type="text/javascript">
        (function () {
            document.createElement('canvas');
            var c = document.createElement('canvas');
            ctx = c.getContext('2d');

            ctx.w = ctx.canvas.width = window.innerWidth;
            ctx.h = ctx.canvas.height = window.innerHeight;
            ctx.canvas.style.position = 'absolute';
            ctx.canvas.style.top = 0;
            ctx.canvas.style.left = 0;

            ctx.clear = function () {
                ctx.clearRect(-ctx.canvas.width / 2, -ctx.canvas.height / 2, ctx.canvas.width, ctx.canvas.height);
            };

            document.body.appendChild(c);
        })();
    </script>

    <script type="text/javascript">
        "use strict";

        function rnd(a) {
            return Math.floor(Math.random() * a) | 0;
        }

        String.prototype.zerofill = function (w) {
            return this.length < w
                ? new Array(w - this.length + 1).join('0') + this
                : this
        }

        const tau = Math.PI * 2;

        CanvasRenderingContext2D.prototype.fillCircle = function (x, y, r) {
            this.beginPath();
            this.arc(x, y, r, 0, tau, false)
            this.closePath();
            this.fill();
        }

        CanvasRenderingContext2D.prototype.strokeCircle = function (x, y, r) {
            this.beginPath();
            this.arc(x, y, r, 0, tau, false)
            this.closePath();
            this.stroke();
        }

        function pointyDerive(row, rule, index) {
            var next = [];
            let isShort = (index % 2) == 0;

            let prevDigit = '0', startIndex = 0;
            if (isShort) {
                prevDigit = row[0];
                startIndex = 1;
            }

            for (var i = startIndex; i < row.length; ++i) {
                let nextDigit = row[i];
                var index = parseInt(prevDigit, 3) * 3 + parseInt(nextDigit, 3);
                next.push(rule[index]);
                prevDigit = nextDigit;
            }

            if (!isShort) {
                next.push(rule[parseInt(prevDigit, 3) * 3])
            }

            return next;
        }

        function randomInitial(w) {
            var ri = [];
            for (var i = 0; i < w; ++i)ri.push(rnd(3))
            return ri.join('')
        }

        function coreInitial(core, w, numCores) {
            var cl = core.length;
            var pl = ((w - (numCores || 1) * cl) / ((numCores || 1) + 1)) | 0;

            var pad = new Array(pl + 1).join('2');
            var r = [pad];
            for (var i = 0; i < numCores; ++i) {
                r.push(core);
                r.push(pad)
            }

            return r.join('');
        }

        let total = 500;
        var initial = coreInitial('101', total, total / 150 | 0);
        initial = randomInitial(total);

        var pointy = {
            init: function () { return rnd(Math.pow(3, 9)).toString(3).zerofill(9).split('') },
            draw: pointyDraw,
            next: pointyDerive
        };

        let algo = pointy;

        let rule = algo.init();
        console.log(rule.join(''));

        //rule = '112112220'

        var goodRules = ['010112021', '222210201', '220201001', '022010210', '220011012', '200010002'];

        let n = total, short = false;
        let row = initial;

        let r = ctx.w / total;
        let color = ['white', 'red', 'black'];
        let outline = ['black', 'white', 'white'];

        ctx.lineWith = .1;

        let ox = (ctx.w - row.length * r) / 2;
        let oy = r;

        tick(row, rule, 0, algo.draw, algo.next);

        function tick(row, rule, index, draw, derive) {
            let over = draw(row, index);

            if (!over) {
                let next = derive(row, rule, index)
                requestAnimationFrame(function () { tick(next, rule, ++index, draw, derive) });
            }
        }

        function pointyDraw(row, index) {
            let y = oy + index * r * .87;
            for (let i = 0; i < row.length; ++i) {
                if (row[i] == 0) continue;

                ctx.fillStyle = color[row[i]];
                ctx.strokeStyle = outline[row[i]];

                ctx.fillCircle(ox + (i - (index % 2) / 2) * r, y, r / 2);
            }

            return y > ctx.h;
        }
    </script>
</body>

</html>