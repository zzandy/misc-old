<!DOCTYPE html>

<html id="doc" lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <link rel="icon" sizes="32x32" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMTZEaa/1AAADBUlEQVRYR62XS08aURTH+RikH8adpkm3NG660MR0YeKiq8Y1rRhZmPQTNDFdmiZNY9yYtpoKtJI+wCqFmgAaRREIw3Nm4PSey1y4cznMXIgn+Ykc4P8/9zH3EQCAIR8CgSAjzEgxLAb4EXh6ooPFSDHCjKDsKZuHGIYsroNjMA0GI+QqgAmhOWlA8T0UgruDA/i5skIZ6MKLEN0+Vcv7lsV+C9DrdilhXbAnglgAjjlpNAno93kB+KqITksYC8AJRxpNAluO0et0KNFpSGEBWrNdEFtYgJ5p8gI6NzeU6DRYWABppPJjeRnuj45Ys3vcXETH6sPnU4MS14Myk/m7sQF2u+3YTY7TYps28IMyFfxeXXXk9eLLLD1BGQtahYIjDWDV685/3lGqWbTRJChj5OvcHBfs2zacLC7y3PDxUwLTbXM0N8qGBbFMA55EsrSpjGos+Le9zcVK+/vDXCuf5zkqXr67hHShBT1WjM3+XJS6kMg2aFMZ2VSmuLPDhbEnRC63tcVzVOzGq7SBH7KpTCUehz575NQ8NQwWazEproNqIKjEYmBWq2N5yzAcW3d8TNZoAz9UAwEut81cbizvNRFJAz9UA0Fpbw+M8/OxPA4LFaY94zCoBn7YjYZj6Y57w6YN/KBMvMhubjqW7sB1gDTwgzLxo3x46NiOgpoDj57/guPMYNLiK75XvzNTAUg2EoH21RUXx8AFSBUX5iLwvfqdmQtA/qyvg/xMHLPlVxanQv6cQwnrUE0kHMlRqL3w4D1gVirQvb0dnogw8Km8rpr8YIJRro92wwedA7H5eb4zYuAiVUsmIRMOD4VevC3yzzBe7V67Tbxg4tqH0no6zQ3wPiByshhuwRjYG3LeA34ojQoxP3Dc8SQs51TRT+nBweX9N63dMYoFaF9MUmtr0C2XXTlCFM4u23xC5u88Ly6DiwkrFotYkkWnQREd0uwM9ozHryeeipbQmxeAMDEs4sEup8/eXEC1Se4P2HJu7irAKQKHA+eE9sRUxL3A63mUIV3PIfAf8eNsoPz6yjkAAAAASUVORK5CYII=">
    <title data-bind="text: windowTitle">Elo Rating tracker</title>
    <style type="text/css">
        html {
            font-size: .7cm;
            max-width: 50em;
            margin: 0 auto;
        }

        html,
        body,
        button {
            background-color: black;
            color: grey;
        }

        .picker {
            border-radius: .3em;
        }

        .picker table {
            border-collapse: collapse;
        }

        #player-list {
            column-count: 2;
            text-align: center;
            transition: all 1s ease-out;
        }

        #player-list button {
            font-size: 180%;
            margin: .3em 0;
        }

        button,
        select {
            font-size: 140%;
            min-width: 7em;
            padding: .5em 1em;
            margin: .1em;
            border-color: hsla(0, 0%, 50%, .7);
            border-radius: .3em;
            background-color: hsla(0, 0%, 1%, .1);
            color: hsla(0, 100%, 100%, .8);
        }

        button:disabled {
            color: hsla(0, 0%, 50%, .3);
            border-color: hsla(0, 0%, 50%, .2);
        }

        .picker td,
        .picker th {
            padding: .1em .5em;
            min-height: 1em;
        }

        .red {
            text-align: left;
        }

        .red,
        .scores .red button.active,
        .scores .red select.active {
            background-color: hsla(0, 100%, 35%, 1);
            color: hsla(0, 100%, 85%, 1);
        }

        .blue {
            text-align: right;
        }

        .blue,
        .scores .blue button.active,
        .scores .blue select.active {
            background-color: hsla(215, 100%, 40%, 1);
            color: hsla(215, 100%, 85%, 1);
        }

        .player {
            font-size: 130%;
            font-weight: bold;
        }

        .scores .red,
        .scores .blue {
            background-color: #76ff03;
            color: #33691e;
        }

        .scores button,
        .scores select {
            font-size: 150%;
            display: block;
        }

        .scores select {
            padding-left: .2em;
        }

        .det-stats table:not(:last-child) {
            margin-bottom: 1em;
        }

        .det-stats td:not(:last-child),
        .stats td:not(:last-child) {
            padding-right: .5em;
        }

        .det-stats .number {
            text-align: right
        }

        .det-stats .text {
            white-space: nowrap
        }
    </style>
    <script type="text/javascript" src="knockout.js"></script>

</head>

<body>
    <div class="picker">
        <table style="width: 100%">
            <tr>
                <th class="red">Red</th>
                <th class="red" data-bind="text: redMatches"></th>
                <th class="blue" data-bind="text: blueMatches"></th>
                <th class="blue">Blue</th>
            </tr>
            <tr>
                <th class="red">Defence</th>
                <th class="red">Offence</th>
                <th class="blue">Offence</th>
                <th class="blue">Defence</th>
            </tr>
            <tr>
                <td class="red player" data-bind="text: picks.red.defence"></td>
                <td class="red player" data-bind="text: picks.red.offence"></td>
                <td class="blue player" data-bind="text: picks.blue.offence"></td>
                <td class="blue player" data-bind="text: picks.blue.defence"></td>
            </tr>
            <tr>
                <td class="red"><button data-bind="click: winRed, disable: isPicking">Win</button></td>
                <td class="red" data-bind="text: expectRed"></td>
                <td class="blue" data-bind="text: expectBlue"></td>
                <td class="blue"><button data-bind="click: winBlue, disable: isPicking">Win</button></td>
            </tr>
            <tr class="scores" data-bind="visible: !isPicking()">
                <td colspan="2" class="red">
                    <button data-bind="css: {'active': redScore() === 0}, click: function(){redScore(0)}, disable: isPicking">0</button>
                    <button data-bind="css: {'active': redScore() === 1}, click: function(){redScore(1)}, disable: isPicking">1</button>
                    <button data-bind="css: {'active': redScore() === 2}, click: function(){redScore(2)}, disable: isPicking">2</button>
                    <button data-bind="css: {'active': redScore() === 3}, click: function(){redScore(3)}, disable: isPicking">3</button>
                    <select data-bind="css: {'active': redScore() === redScoreX()}, options: ['+',4,5,6,7,8,9,10], value: redScoreX, disable: isPicking"></select>
                </td>
                <td colspan="2" class="blue">
                    <button data-bind="css: {'active': blueScore() === 0}, click: function(){blueScore(0)}, disable: isPicking">0</button>
                    <button data-bind="css: {'active': blueScore() === 1}, click: function(){blueScore(1)}, disable: isPicking">1</button>
                    <button data-bind="css: {'active': blueScore() === 2}, click: function(){blueScore(2)}, disable: isPicking">2</button>
                    <button data-bind="css: {'active': blueScore() === 3}, click: function(){blueScore(3)}, disable: isPicking">3</button>
                    <select data-bind="css: {'active': blueScore() === blueScoreX()}, options: ['+',4,5,6,7,8,9,10], value: blueScoreX, disable: isPicking"></select>
                </td>
            </tr>
        </table>
    </div>

    <div style="text-align: center">
        <button style="width: 5em" data-bind="click: reset, disable:pickStatus()=='Red Defence'">Cancel</button>
        <button data-bind="click: resetScores, disable:!scoresPresent()">Drop Scores</button>
        <button style="width: 5em" data-bind="click: saveScore, disable:!allScoresPresent()">Submit</button>
    </div>

    <script id="player-template" type="text/html">
        <div>
            <button data-bind="text: $data, visible: $data != '{add new}', disable: $root.isPicked($data), click: function(){$root.pick($data)}"></button>
            <button data-bind="visible: $data == '{add new}', click: $root.queryForUser"><u>Add Player</u></button>
        </div>
    </script>

    <div id="player-list" data-bind="visible: isPicking, template: {name: 'player-template', foreach: playersSorted}"></div>

    <table class="stats" data-bind="foreach: stats">
        <tr>
            <td data-bind="text: label"></td>
            <td data-bind="text: team.label"></td>
            <td class="number" data-bind="text: team.value"></td>
            <td data-bind="text: player.label"></td>
            <td class="number" data-bind="text: player.value"></td>
        </tr>
    </table>

    <button data-bind="click: showStats, text: isStatsShown() ? 'Less stats' : 'More stats'"></button>
    <button data-bind="event: {mousedown: initateRestCountdown, mouseup: cancelRestCountdown, touchstart: initateRestCountdown, touchend: cancelRestCountdown}">Clear stats</button>

    <script id="stats-template" type="text/html">
        <table>
            <thead>
                <tr data-bind="foreach: columns">
                    <!-- ko if: $index() == 0 -->
                    <th>#</th>
                    <!-- /ko -->
                    <th data-bind="text: title + '&nbsp;' + ind(), click: toggle">Name</th>
                </tr>
            </thead>
            <tbody data-bind="template: {name: 'stat-line-template', foreach: rows}"></tbody>
        </table>
    </script>

    <script id="stat-line-template" type="text/html">
        <tr data-bind="foreach: [$index()+1].concat(data)">
            <td data-bind="text: $data, css: $parent.className[$index()-1]"></td>
        </tr>
    </script>

    <div class="det-stats" data-bind="visible: isStatsShown, template: {name: 'stats-template', foreach: detailedStats}" />

    <script type="text/javascript">
        function Elo(initScore, x10diff, kFactor) {
            this.initScore = initScore || 800;
            this.x10diff = x10diff || 400;
            this.kFactor = kFactor || 32;
        }

        Elo.prototype.expectWin = function (a, b) {
            return 1 / (1 + Math.pow(10, ((b.score || this.initScore) - (a.score || this.initScore)) / this.x10diff));
        }

        Elo.prototype.update = function (winner, looser, tie) {
            var expecta = this.expectWin(winner, looser);
            var expectb = this.expectWin(looser, winner);

            this.updatePlayer(winner, expecta, tie ? .5 : 1);
            this.updatePlayer(looser, expectb, tie ? .5 : 0);
        }

        Elo.prototype.updatePlayer = function (a, expected, scoreForA) {
            var delta = this.kFactor * (scoreForA - expected);

            a.score = Math.max(0, (a.score || this.initScore) + delta);
            a.numMatches = (a.numMatches || 0) + 1;
            a.numWins = (a.numWins || 0) + (scoreForA == 1);
        }
    </script>

    <script type="text/javascript">
        "use strict";
        function request(verb, url, data) {
            return new Promise(function (resolve, reject) {
                var http = new XMLHttpRequest();

                http.open(verb, url, true);
                http.setRequestHeader('Content-type', 'application/json; charset=utf-8');

                http.onreadystatechange = function () {
                    if (http.readyState == 4) {
                        if (http.status == 200) {
                            resolve(JSON.parse(http.responseText));
                        }
                        else {
                            reject('POST ' + url + ': ' + http.statusText + '. ' + http.responseText);
                        }
                    }
                }

                if (data)
                    http.send(JSON.stringify(data));
                else http.send(null);
            });
        }

        function postJson(url, data) {
            return request('POST', url, data);
        }

        function getJson(url) {
            return request('GET', url)
        }
    </script>

    <script type="text/javascript">
        // wrap a function for a promise chain
        function gogo(fn) {
            var args = [].slice.call(arguments, 1);
            return function (a) {
                return fn.apply(null, [a].concat(args));
            }
        }

        // chain promises
        function chain(promise) {
            for (var prom of arguments) {
                if (prom == promise) continue;
                promise = promise.then(prom);
            }

            return promise;
        }
    </script>

    <script type="text/javascript">
        function AlmazApi(baseUrl, source) {
            this.scope = Promise.resolve({ url: baseUrl, source: source, players: [] });
            this.scope.then(refreshPlayers);
        }

        var playerMapping = {
            'Almaz': 'Almaz Khannanov',
            'Nikita': 'Mykyta Datsko',
            'Andriy': 'Andriy Vynogradov',
            'Sergii K': 'Sergii Kozak',
            'Vova T': 'Volodymyr Troskot',
            'Dmytro': 'Dmytro Kudryavtsev',
            'Vova G': 'Volodymyr Havrysh',
            'Sergii S': 'Serhii Shelest',
            'Anton': 'Anton Potashov'
        }

        AlmazApi.prototype.postMatch = function (game) {
            this.scope = chain(this.scope,
                gogo(checkPlayers, game),
                gogo(postMatch)
            )
        }

        function refreshPlayers(ctx) {
            return getJson(ctx.url + 'players')
                .then(function (players) { ctx.players = players; return ctx; })
                .catch(function (e) {
                    console.error(e);
                    return ctx;
                });
        }

        function matchPlayer(players, customName) {
            for (var player of players) {
                if (customName == player.firstName + ' ' + player.secondName
                    || (customName in playerMapping && playerMapping[customName] == player.firstName + ' ' + player.secondName))
                    return player;
            }
        }

        function checkPlayers(ctx, game, secondTry) {
            var redDefenceId = matchPlayer(ctx.players, game.red.defence);
            var redOffenceId = matchPlayer(ctx.players, game.red.offence);
            var blueDefenceId = matchPlayer(ctx.players, game.blue.defence);
            var blueOffenceId = matchPlayer(ctx.players, game.blue.offence);

            var missing = [];
            if (redDefenceId == null) missing.push(redDefenceId);
            if (redOffenceId == null) missing.push(redOffenceId);
            if (blueDefenceId == null) missing.push(blueDefenceId);
            if (blueOffenceId == null) missing.push(blueOffenceId);

            if (missing.length != 0) {
                if (secondTry) {
                    if (redDefenceId == null) console.log('Player not found ' + game.red.defence);
                    if (redOffenceId == null) console.log('Player not found ' + game.red.offence);
                    if (blueDefenceId == null) console.log('Player not found ' + game.blue.defence);
                    if (blueOffenceId == null) console.log('Player not found ' + game.blue.offence);
                    return ctx;
                }
                return refreshPlayers(ctx).then(function (ctx) { return checkPlayers(ctx, game, true) });
            }
            else {
                ctx.match = {
                    startDate: game.date,
                    endDate: game.date,
                    source: ctx.source,
                    red: {
                        defense: redDefenceId,
                        offense: redOffenceId,
                        score: game.red.score || (game.winner == 'red' ? 1 : 0),
                    },
                    blue: {
                        defense: blueDefenceId,
                        offense: blueOffenceId,
                        score: game.blue.score || (game.winner == 'blue' ? 1 : 0),
                    },
                    metadata: {
                        ratingChange: {
                            red: {
                                from: game.red.ratingBefore,
                                to: game.red.ratingAfter
                            },
                            blue: {
                                from: game.blue.ratingBefore,
                                to: game.blue.ratingAfter
                            }
                        }
                    }
                }

                return ctx;
            }
        }

        function postMatch(ctx) {
            if (!('url' in ctx))
                throw 'Invalid context';

            if (!('match' in ctx))
                return ctx;

            var match = ctx.match;
            delete ctx.match;

            return postJson(ctx.url + 'games', match)
                .then(function (a) { return ctx })
                .catch(function (e) { console.error(e); return ctx; })
        }
    </script>

    <script type="text/javascript">
        var apiSource = localStorage.getItem('kicker-api-source');
        if (apiSource == null) {
            apiSource = prompt("Please enter a name for this client.");
            localStorage.setItem('kicker-api-source', apiSource);
        }

        function KickerModel() {
            var $ = this;

            $.windowTitle = ko.observable('Elo Rating Tracker');

            var api = new AlmazApi('http://foosball-results.herokuapp.com/api/', 'og-source/' + apiSource);

            var teams = localStorage.getItem('kicker-teams');
            teams = (teams && JSON.parse(teams)) || [];

            (function () {
                var games = localStorage.getItem('kicker-games');

                games = (games && JSON.parse(games)) || [];

                var backlogUploaded = localStorage.getItem('kicker-backlog-uploaded');
                if (!backlogUploaded) {
                    for (var game of games) {
                        api.postMatch(game);
                    }

                    localStorage.setItem('kicker-backlog-uploaded', true);
                }
            })();

            var players = teams.reduce(function (plyrs, team) {
                function tryAdd(plyr) {
                    if (plyrs.indexOf(plyr) == -1)
                        plyrs.push(plyr);
                }

                tryAdd(team.team.defence);
                tryAdd(team.team.offence);

                return plyrs;
            }, 'Vova T; Vova G; Sergii K; Sergii S; Dmytro; Andriy; Almaz; Anton'.split('; '));

            $.players = ko.observableArray(players);
            $.playersSorted = ko.computed(function () {
                var sorted = $.players.slice().sort(sortCI);
                return sorted.concat('{add new}');
            });

            var noPick = '---';

            $.pickStatus = ko.observable('Red Defence');
            $.picks = {
                red: {
                    defence: ko.observable(noPick),
                    offence: ko.observable(noPick),
                    team: ko.observable(null)
                },
                blue: {
                    defence: ko.observable(noPick),
                    offence: ko.observable(noPick),
                    team: ko.observable(null)
                }
            };

            $.redScore = ko.observable(null);
            $.blueScore = ko.observable(null);

            $.redScoreX = ko.computed({
                read: function () { return $.redScore() < 4 ? '+' : $.redScore() },
                write: function (value) { if (value >= 4 && value <= 10) $.redScore(value) }
            });

            $.blueScoreX = ko.computed({
                read: function () { return $.blueScore() < 4 ? '+' : $.blueScore() },
                write: function (value) { if (value >= 4 && value <= 10) $.blueScore(value) }
            });

            function getScore(team) {
                return function () {
                    var t = team();

                    return t == null || t.score === undefined
                        ? ''
                        : t.score.toFixed(0);
                }
            }

            $.queryForUser = function () {
                var name = prompt("Enter new player name").trim();

                if (name != '' && !$.players().some(function (p) { return p == name })) {
                    $.players.push(name)
                    $.pick(name);
                }
            }

            $.pick = function (player) {
                if ($.isPicked(player))
                    return;

                var status = $.pickStatus();
                switch (status) {
                    case 'Red Defence': $.picks.red.defence(player);
                        $.pickStatus('Red Offence');
                        break;
                    case 'Red Offence': $.picks.red.offence(player);
                        $.pickStatus('Blue Offence');
                        break;
                    case 'Blue Offence': $.picks.blue.offence(player);
                        $.pickStatus('Blue Defence');
                        break;
                    case 'Blue Defence': $.picks.blue.defence(player);
                        $.pickStatus('Ready');
                        break;
                }

                if ($.picks.red.defence() != noPick
                    && $.picks.red.offence() != noPick
                    && $.picks.blue.defence() != noPick
                    && $.picks.blue.offence() != noPick) {
                    pullExpected();
                    $.pickStatus('Ready');
                }
            }

            $.winRed = function () { win('red', 'blue') }
            $.winBlue = function () { win('blue', 'red') }

            $.saveScore = function () {
                var a = $.redScore();
                var b = $.blueScore();
                if ((a !== null && a >= 0 && a <= 10) && (b !== null && b >= 0 && b <= 10)) {
                    if (a > b)
                        win('red', 'blue');
                    else if (a < b)
                        win('blue', 'red')
                }
                else (reset())
            }

            $.redMatches = ko.computed(function () {
                return reprMatches($.picks.red.team());
            });

            $.blueMatches = ko.computed(function () {
                return reprMatches($.picks.blue.team());
            });

            function reprMatches(team) {
                if (properTeam(team)) {
                    var n = team.numMatches;
                    return n + ' game' + (n == 1 ? '' : 's');
                }
                return '';
            }

            var winStreakTeam = null;
            var winStreak = 0;

            $.resetScores = function () {
                $.redScore(null);
                $.blueScore(null);
            }

            $.reset = function () {
                winTeam = null;
                winStreak = 0;

                $.pickStatus('Red Defence');

                $.expectRed('');
                $.expectBlue('');

                $.picks.red.defence('---');
                $.picks.red.offence('---');
                $.picks.red.team(null);

                $.picks.blue.defence('---');
                $.picks.blue.offence('---');
                $.picks.blue.team(null);

                $.resetScores()
            }

            $.scoresPresent = ko.computed(function () {
                var a = $.redScore(); var b = $.blueScore();
                return (a !== null && a >= 0 && a <= 10) || (b !== null && b >= 0 && b <= 10);
            });

            $.allScoresPresent = ko.computed(function () {
                var a = $.redScore(); var b = $.blueScore();
                return a != b && (a !== null && a >= 0 && a <= 10) && (b !== null && b >= 0 && b <= 10);
            });

            teamsUpdate = ko.observable();

            function win(winner, looser) {
                var won = $.picks[winner].team();
                var lost = $.picks[looser].team();

                if (won == winStreakTeam)
                    winStreak += 1;
                else {
                    winStreak = 1;
                    winStreakTeam = won;
                }

                if (winStreak < 3) {
                    $.expectRed('');
                    $.expectBlue('');

                    $.picks[winner].defence(won.team.defence);
                    $.picks[winner].offence(won.team.offence);
                    $.picks[winner].team(won);

                    $.picks[looser].defence(lost.team.offence);
                    $.picks[looser].offence(noPick);
                    $.picks[looser].team(null);

                    $.pickStatus(winner == 'red' ? 'Blue Offence' : 'Red Offence');
                }
                else {
                    $.expectRed('');
                    $.expectBlue('');

                    $.picks[winner].defence(won.team.defence);
                    $.picks[winner].offence(noPick);
                    $.picks[winner].team(null);

                    $.picks[looser].defence(lost.team.offence);
                    $.picks[looser].offence(won.team.offence);
                    $.picks[looser].team(findTeam(lost.team.offence, won.team.offence));

                    $.pickStatus(winner == 'blue' ? 'Blue Offence' : 'Red Offence');
                }

                var updateObj = {
                    date: new Date(),
                    winner: winner
                };

                updateObj[winner] = {
                    ratingBefore: won.score,
                    defence: won.team.defence,
                    offence: won.team.offence,
                }

                updateObj[looser] = {
                    ratingBefore: lost.score,
                    defence: lost.team.defence,
                    offence: lost.team.offence,
                }

                elo.update(won, lost);

                if ($.allScoresPresent()) {
                    updateObj[winner].score = $[winner + 'Score']();
                    updateObj[looser].score = $[looser + 'Score']();
                }

                $.resetScores()

                updateObj[winner].ratingAfter = won.score;
                updateObj[looser].ratingAfter = lost.score;

                updateGamesLog(updateObj);

                // trigger stats update
                teamsUpdate(teamsUpdate() + 1);
                localStorage.setItem('kicker-teams', JSON.stringify($.teams()));
            }



            function updateGamesLog(upd) {
                var maxGamesLength = 1000;
                var games = localStorage.getItem('kicker-games');

                games = (games && JSON.parse(games)) || [];

                games.push(upd);

                api.postMatch(upd);

                if (games.length > maxGamesLength) {
                    games.splice(0, games.length - maxGamesLength);
                }

                localStorage.setItem('kicker-games', JSON.stringify(games))
            }

            var resetTimer = null;
            var clickTimer = null;
            var click = false;
            $.initateRestCountdown = function () {
                resetTimer = setTimeout(initiateReset, 5000);

                click = true;
                clickTimer = setTimeout(cancelClick, 100);
            }

            function cancelClick() {
                click = false;
            }

            $.cancelRestCountdown = function () {
                clearTimeout(resetTimer)
                clearTimeout(clickTimer);

                if (click) {
                    $.reset()
                }
            }

            function initiateReset() {
                if (confirm('Are you sure you want to reset statistics?'))
                    reset();
            }

            function reset() {
                localStorage.clear();
                document.location.reload();
            }

            $.expectRed = ko.observable('');
            $.expectBlue = ko.observable('');

            $.teams = ko.observableArray(teams);
            var elo = new Elo();

            function pullExpected() {
                var red = findTeam($.picks.red.defence(), $.picks.red.offence());
                var blue = findTeam($.picks.blue.defence(), $.picks.blue.offence());

                $.expectRed((elo.expectWin(red, blue) * 100).toFixed(0) + '%');
                $.expectBlue((elo.expectWin(blue, red) * 100).toFixed(0) + '%');

                $.picks.red.team(red);
                $.picks.blue.team(blue);
            }

            function findTeam(defence, offence) {
                var teams = $.teams();

                var team = null;

                // search for exact match
                for (var i = 0; i < teams.length; ++i) {
                    var item = teams[i];
                    if (item.team.offence == offence && item.team.defence == defence) {
                        return item;
                    }
                }

                // search for reverse match
                for (var i = 0; i < teams.length; ++i) {
                    var item = teams[i];
                    if (item.team.offence == defence && item.team.defence == offence) {
                        team = { team: { offence: offence, defence: defence }, score: item.score };
                        $.teams.push(team);
                        return team;
                    }
                }

                // search score by players average score is similar teams
                var score1 = findScore(defence, 'defence', 'offence', teams), score2 = findScore(offence, 'offence', 'defence', teams);

                if (score1 > 0 && score2 > 0) {
                    team = { team: { offence: offence, defence: defence }, score: (score1 + score2) / 2 };
                    $.teams.push(team);

                    return team;
                }

                // if nothing found create new
                if (team == null) {
                    team = { team: { offence: offence, defence: defence } }
                    $.teams.push(team);

                    return team;
                }

                return team;
            }

            function findScore(player, role1, role2, teams) {
                function sum(acc, team) {
                    return acc + team.team.score;
                }

                var match = teams.filter(function (team) { return team[role1] == player });

                if (match.length > 0)
                    return match.reduce(sum, 0) / match.length;

                match = teams.filter(function (team) { return team[role2] == player });

                if (match.length > 0)
                    return match.reduce(sum, 0) / match.length;

                return 0;
            }

            $.isPicking = ko.computed(function () { var status = $.pickStatus(); return 'Offence;Defence'.split(';').some(function (word) { return status.indexOf(word) > -1 }) });

            $.isPicked = function (player) {

                var v = $.isPicking()
                    && ($.picks.red.defence() == player || $.picks.red.offence() == player || $.picks.blue.defence() == player || $.picks.blue.offence() == player);

                return v;
            }

            $.stats = ko.computed(function () {
                function stat(label, team, player) {
                    return {
                        label: label,
                        team: team === undefined ? { label: 'n/a', value: '' } : { label: team.defence + "(d)+" + team.offence + "(o)", value: team.score.toFixed(0) },
                        player: { label: player.player, value: player.score.toFixed(0) }
                    };
                }

                function pickTeam(sortBy, reverse, skip) {
                    skip = skip || 0;
                    var sorted = $.teams.slice().filter(notNan(sortBy));

                    sorted.sort(function (a, b) { var cmp = (sortBy(a) || 0) - (sortBy(b) || 0); return reverse ? - cmp : cmp });

                    return sorted[0 + skip] && {
                        offence: sorted[0 + skip].team.offence,
                        defence: sorted[0 + skip].team.defence,
                        score: sortBy(sorted[0 + skip]) || NaN
                    };
                }

                function pickPlayer(sortBy, reverse, total, skip) {
                    skip = skip || 0;
                    var obj = $.teams().reduce(function (acc, team) {
                        function upd(player) {
                            var record = acc[player] || { scores: [] };
                            var val = sortBy(team);

                            if (val) {
                                record.scores.push(val);
                                acc[player] = record;
                            }
                        }

                        upd(team.team.defence);
                        upd(team.team.offence);

                        return acc;
                    }, {});

                    var players = []

                    for (var i in obj) {
                        var scores = obj[i].scores
                        players.push([i, scores.reduce(max) / 10000 + (total ? scores.reduce(sum) : scores.reduce(sum) / scores.length)]);
                    }

                    var top = players.sort(function (a, b) { return reverse ? b[1] - a[1] : a[1] - b[1] })[0 + skip];

                    return top === undefined ? { player: 'n/a', score: NaN } : { player: top[0], score: top[1] };
                }

                var dummy = teamsUpdate();
                return [
                    { label: "total", team: { label: $.teams().length + ' teams', value: '' }, player: { label: $.teams().filter(properTeam).reduce(function (sum, team) { return sum + team.numMatches }, 0) / 2 + ' games', value: '' } },
                    stat('highest rating', pickTeam(teamScore, true), pickPlayer(teamScore, true, false)),
                    stat('2nd highest', pickTeam(teamScore, true, 1), pickPlayer(teamScore, true, false, 1)),
                    stat('3rd highest', pickTeam(teamScore, true, 2), pickPlayer(teamScore, true, false, 2)),
                    stat('lowest rating', pickTeam(teamScore, false), pickPlayer(teamScore, false)),
                    stat('most games', pickTeam(matches, true), pickPlayer(matches, true, true)),
                    stat('least games', pickTeam(matches, false), pickPlayer(matches, false, true)),
                    stat('most wins', pickTeam(numWins, true), pickPlayer(numWins, true, true)),
                    stat('most losses', pickTeam(numLosses, true), pickPlayer(numLosses, true, true)),
                ];
            });

            var teamStats = [['defence;Defence', defence], ['offence;Offence', offence], ['score;Rank', teamScore2], ['wins;Wins', numWins], ['losses;Losses', numLosses], ['ratio;Wins%', ratio, percent], ['games;Games', matches]];
            var playerStats = [['name;Name', name],
            ['max;Max Rank', maxRank], ['maxd;(d)', maxRankd], ['maxd;(o)', maxRanko],
            ['avg;Average Rank', avgRank], ['avgd;(d)', avgRankd], ['avgo;(o)', avgRanko],
            ['wins;Wins', numWins], ['losses;Losses', numLosses],
            ['ratio;Wins%', ratio, percent], ['ratiod;(d)', ratiod, percent], ['ratioo;(o)', ratioo, percent],
            ['games;Games', matches]
            ];

            var up = '\u25b2'; // ▲
            var down = '\u25bc'; // ▼
            var none = '\u00a0\u00a0\u00a0';

            teamStats = teamStats.map(parseStats);
            playerStats = playerStats.map(parseStats)

            teamStats.forEach(addSort);
            playerStats.forEach(addSort);

            function isText(name) { return name == 'defence' || name == 'offence' || name == 'name' }

            function isDefault(name) { return name == 'score' || name == 'max' }

            function parseStats(stat) {
                var name = stat[0].split(';');
                var ind = ko.observable(isDefault(name[0]) ? down : none);

                return { name: name[0], title: name[1], fetch: stat[1], ind: ind, toggle: null, formatter: stat[2] || null, className: isText(name[0]) ? 'text' : 'number' }
            }

            function addSort(stat, i, a) {
                stat.toggle = function () {
                    var order = stat.ind();
                    a.forEach(function (other) { other.ind(none) });
                    stat.ind(order == down ? up : (isText(stat.name) && order == none) ? up : down);
                }
            }

            $.isStatsShown = ko.observable(false);

            var properTeams = ko.computed(function () {
                if (!$.isStatsShown()) return [];

                var dummy = teamsUpdate();
                return $.teams().filter(properTeam);
            })

            var teamData = ko.observable([]);

            var teamDataX = ko.computed(function () {
                teamData(properTeams().map(fetchTeamStats));
            });

            var sortedTeamData = ko.computed(function () {
                var d = teamData();
                d.sort(byTeamStats);

                return d;
            });

            var playerData = ko.observable([]);
            var playerDataX = ko.computed(function () {
                playerData(properTeams().reduce(fetchPlayerData, [{}]).reduce(unwrap, []).map(fetchPlayerStats));
            });

            var sortedPlayerData = ko.computed(function () {
                var data = playerData();
                data.sort(byPlayerStats);

                return data;
            });

            $.detailedStats = ko.computed(function () {
                var teams = { columns: teamStats, rows: sortedTeamData() };
                var players = { columns: playerStats, rows: sortedPlayerData() };
                return [teams, players];
            });

            function fetchTeamStats(team) {
                var dummy = teamsUpdate();

                return teamStats.reduce(function (data, stat) {
                    data[stat.name] = stat.fetch(team);
                    data.data.push(stat.formatter ? stat.formatter(data[stat.name]) : data[stat.name]);
                    data.className.push(stat.className);
                    return data;
                }, { data: [], className: [] });
            }

            function byTeamStats(teama, teamb) {
                var stat = teamStats.filter(function (stat) { return stat.ind() != none })[0];
                return stat ? (stat.ind() == up ? cmp(teama[stat.name], teamb[stat.name]) : -cmp(teama[stat.name], teamb[stat.name]))
                    : 0;
            }

            function updatePlayerAspect(team, player) {
                (player.scores || (player.scores = [])).push(team.score);
                player.numMatches = (player.numMatches || 0) + team.numMatches;
                player.numWins = (player.numWins || 0) + team.numWins;
            }

            function updatePlayer(team, player, scope) {
                updatePlayerAspect(team, player)
                updatePlayerAspect(team, player[scope] || (player[scope] = {}));
            }

            function fetchPlayerData(acc, team) {
                var obj = acc[0];

                var defence = team.team.defence in obj ? obj[team.team.defence] : obj[team.team.defence] = {};
                var offence = team.team.offence in obj ? obj[team.team.offence] : obj[team.team.offence] = {};

                updatePlayer(team, defence, 'defence')
                updatePlayer(team, offence, 'offence')

                return acc;
            }

            function unwrap(acc, playerData) {
                for (var i in playerData) { playerData[i].name = i; acc.push(playerData[i]) }
                return acc;
            }

            function fetchPlayerStats(player) {
                return playerStats.reduce(function (data, stat) {
                    data[stat.name] = stat.fetch(player);
                    data.data.push(stat.formatter ? stat.formatter(data[stat.name]) : data[stat.name]);
                    data.className.push(stat.className);
                    return data;
                }, { data: [], className: [] });
            }

            function byPlayerStats(p1, p2) {
                var stat = playerStats.filter(function (stat) { return stat.ind() != none })[0];

                return stat
                    ? (stat.ind() == up ? cmp(p1[stat.name], p2[stat.name]) : -cmp(p1[stat.name], p2[stat.name]))
                    : 0;
            }

            $.showStats = function () {
                $.isStatsShown(!$.isStatsShown());
            }
        }

        ko.applyBindings(new KickerModel(), document.getElementById('doc'));

        function sortCI(a, b) { return a.toLowerCase() > b.toLowerCase() ? 1 : -1; }
        function sum(acc, s) { return acc + (s || 0) }
        function max(acc, s) { return Math.max(acc, s || -Infinity) }
        function cmp(a, b) { return a == 'n/a' ? -1 : b == 'n/a' ? 1 : a > b ? 1 : a == b ? 0 : -1 }

        function matches(team) { return team.numMatches }
        function teamScore(team) { return team.score }
        function teamScore2(team) { return team.score && team.score.toFixed(0) || 'n/a' }
        function defence(team) { return team.team.defence }
        function offence(team) { return team.team.offence }
        function numWins(team) { return team.numWins }
        function numLosses(team) { return team.numMatches - team.numWins }
        function name(player) { return player.name }

        function maxRank(p) { return p.scores.reduce(max).toFixed(0) }
        function maxRankd(p) { return p.defence && maxRank(p.defence) || 'n/a' }
        function maxRanko(p) { return p.offence && maxRank(p.offence) || 'n/a' }

        function avgRank(p) { return (p.scores.reduce(sum) / p.scores.length).toFixed(0) }
        function avgRankd(p) { return p.defence && avgRank(p.defence) || 'n/a' }
        function avgRanko(p) { return p.offence && avgRank(p.offence) || 'n/a' }

        function ratiod(p) { return p.defence && ratio(p.defence) || 'n/a' }
        function ratioo(p) { return p.offence && ratio(p.offence) || 'n/a' }

        function ratio(team) { return (team.numMatches == 0 ? 0 : team.numWins / team.numMatches) }
        function percent(v) { return isNaN(v) ? 'n/a' : (v * 100).toFixed(0) + "%" }

        function properTeam(team) { return !!team && 'numMatches' in team && team.numMatches > 0 }

        function notNan(getter) {
            return function (i) {
                return !isNaN(getter(i));
            }
        }
    </script>

</body>

</html>