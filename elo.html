<!DOCTYPE html>

<html id="doc" lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title data-bind="text: windowTitle">Elo Rating tracker</title>
    <style type="text/css">
        .disabled {
            color: gray
        }
        .picker{
            border-collapse: collapse;
        }
        .picker td, .picker th{
            padding: .1em .5em;
            min-height: 1em;
        }
        .red{
            background-color: hsla(0, 100%, 85%, 1);
            color: hsla(0,100%, 15%, 1);
        }
        .blue{
            background-color: hsla(215, 100%, 90%, 1);
            color: hsla(215,100%, 15%, 1);
        }
    </style>
    <script type="text/javascript" src="knockout.js"></script>

</head>

<body>
    <script id="player-template" type="text/html">
        <div>
            <span data-bind="text: $data, css: { disabled: $root.isPicked($data)}, click: function(){$root.pick($data)}"></span>
        </div>
    </script>

    <div id="player-list" data-bind="visible: isPicking(), template: {name: 'player-template', foreach: players().sort()}"></div>

    <table class="picker">
        <tr>
            <th class="red" colspan="2">Red</th><th class="blue" colspan="2">Blue</th>
        </tr>
        <tr>
            <th class="red">Defence</th><th class="red">Offence</th><th class="blue">Offence</th><th class="blue">Defence</th>
        </tr>
        <tr>
            <td class="red" data-bind="text: picks.red.defence"></td>
            <td class="red" data-bind="text: picks.red.offence"></td>
            <td class="blue" data-bind="text: picks.blue.offence"></td>
            <td class="blue" data-bind="text: picks.blue.defence"></td>
        </tr>
        <tr>
            <td class="red"><button data-bind="click: winBlue">Win</button></td>
            <td class="red" data-bind="text: expectRed"></td>
            <td class="blue" data-bind="text: expectBlue"></td>
            <td class="blue"><button data-bind="click: winRed">Win</button></td>
        </tr>
    </table>

    <script type="text/javascript">
        function Elo(initScore, x10diff, kFactor) {
            this.initScore = initScore || 800;
            this.x10diff = x10diff || 400;
            this.kFactor = kFactor || 32;
        }

        Elo.prototype.expectWin = function (a, b) {
            return 1 / (1 + Math.pow(10, ((a.score || this.initScore) - (b.score || this.initScore)) / this.x10diff));
        }

        Elo.prototype.update = function (winner, looser, tie) {
            this.updatePlayer(winner, looser, tie ? .5 : 1);
            this.updatePlayer(looser, winner, tie ? .5 : 0);
        }

        Elo.prototype.updatePlayer = function (a, b, scoreForA) {
            var expected = this.expectWin(a, b);

            var delta = this.kFactor * (scoreForA - expected);
            a.score = Math.max(0, (a.score || this.initScore) + delta);
            a.numMatches = (a.numMatches || 0) + 1;
        }
    </script>

    <script type="text/javascript">
        function p(name) {
            return { name: name };
        }

        var elo = new Elo();
        var contenders = 'pineaple; mango; apple; grapefruit; pommegranate; peach; melon; plum; cherry; banana'.split(';').map(function (a) { return p(a.trim()) });

        for (var i = 0; i < contenders.length; ++i) {
            for (var j = i + 1; j < contenders.length; ++j) {

                if (Math.random() < .8)
                    elo.update(contenders[i], contenders[j]);
                else
                    elo.update(contenders[j], contenders[i]);

                //console.log('new score: ' + contenders[i].name + ' '+ contenders[i].score+' vs ' + contenders[j].name+' '+contenders[j].score);
            }
        }
    </script>

    <script type="text/javascript">
        function KickerModel(data) {
            var $ = this;

            $.windowTitle = ko.observable('Elo Rating Tracker');
            $.players = ko.observableArray((data && data.players) || ('Vova T; Vova G; Sergii K; Sergii S; Dmytro; Andriy; Almaz; Anton'.split('; ')));
            $.pickStatus = ko.observable('Red Defence');
            $.picks = {
                red: {
                    defence: ko.observable('---'),
                    offence: ko.observable('---')
                },
                blue: {
                    defence: ko.observable('---'),
                    offence: ko.observable('---')
                }
            };

            $.pick = function (player) {
                if($.isPicked(player))
                    return;

                var status = $.pickStatus();
                switch (status) {
                    case 'Red Defence': $.picks.red.defence(player);
                        $.pickStatus('Red Offence');
                        break;
                    case 'Red Offence': $.picks.red.offence(player);
                        $.pickStatus('Blue Offence');
                        break;
                    case 'Blue Offence': $.picks.blue.offence(player);
                        $.pickStatus('Blue Defence');
                        break;
                    case 'Blue Defence': $.picks.blue.defence(player);
                        $.pickStatus('Ready');
                        break;
                }

                if($.pickStatus() == "Ready"){
                    pullExpected();
                }
            }

            $.winBlue = function(){}
            $.winRed = function(){}

            $.expectRed = ko.observable('');
            $.expectBlue = ko.observable('');

            function pullExpected(){
                var red = findTeam($.picks.red.defence(), $.picks.red.offence());
                var blue = findTeam($.picks.blue.defence(), $.picks.blue.offence());
            }

            function findTeam(defence, offence){

            }

            $.isPicking = ko.computed(function(){var status = $.pickStatus();return 'Offence;Defence'.split(';').some(function (word) { return status.indexOf(word) > -1 })});

            $.isPicked = function (player) {
                
                var v = $.isPicking()
                    && ($.picks.red.defence() == player || $.picks.red.offence() == player || $.picks.blue.defence() == player || $.picks.blue.offence() == player);

                return v;
            }
        }

        ko.applyBindings(new KickerModel(localStorage.getItem('kicker-data')), document.getElementById('doc'));
    </script>

</body>

</html>