<!DOCTYPE html>

<html id="doc" lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title data-bind="text: windowTitle">Elo Rating tracker</title>
    <style type="text/css">
        html,
        body,
        button {
            font-size: 1cm;
            background-color: black;
            color: grey;
        }

        .picker {
            border-radius: .3em;
        }

        .picker table {
            border-collapse: collapse;
        }

        #player-list {
            column-count: 2;
            text-align: center;
            transition: all 1s ease-out;
        }

        #player-list button {
            font-size: 150%;
            margin: .3em 0;
        }

        button {
            font-size: 120%;
            min-width: 7em;
            padding: .5em 1em;
            margin: .1em;
            border-color: hsla(0, 0%, 50%, .7);
            border-radius: .3em;
            background-color: hsla(0, 0%, 1%, .1);
            color: hsla(0, 100%, 100%, .8);
        }

        button:disabled {
            color: hsla(0, 0%, 50%, .3);
            border-color: hsla(0, 0%, 50%, .2);
        }

        .picker td,
        .picker th {
            padding: .1em .5em;
            min-height: 1em;
        }

        .red {
            text-align: left;
            background-color: hsla(0, 100%, 35%, 1);
            color: hsla(0, 100%, 85%, 1);
        }

        .blue {
            text-align: right;
            background-color: hsla(215, 100%, 40%, 1);
            color: hsla(215, 100%, 85%, 1);
        }
    </style>
    <script type="text/javascript" src="knockout.js"></script>

</head>

<body>
    <div class="picker">
        <table style="width: 100%">
            <tr>
                <th class="red" colspan="2">Red</th>
                <th class="blue" colspan="2">Blue</th>
            </tr>
            <tr>
                <th class="red">Defence</th>
                <th class="red">Offence</th>
                <th class="blue">Offence</th>
                <th class="blue">Defence</th>
            </tr>
            <tr>
                <td class="red" data-bind="text: picks.red.defence"></td>
                <td class="red" data-bind="text: picks.red.offence"></td>
                <td class="blue" data-bind="text: picks.blue.offence"></td>
                <td class="blue" data-bind="text: picks.blue.defence"></td>
            </tr>
            <tr>
                <td class="red"><button data-bind="click: winRed, disable: isPicking">Win</button></td>
                <td class="red" data-bind="text: expectRed"></td>
                <td class="blue" data-bind="text: expectBlue"></td>
                <td class="blue"><button data-bind="click: winBlue, disable: isPicking">Win</button></td>
            </tr>
        </table>
    </div>

    <div style="align-content: center">
        <button style="display: block; margin-left: auto; margin-right: auto; width: 5em" data-bind="click: reset, disable:pickStatus()=='Red Defence', event: {mousedown: initateRestCountdown, mouseup: cancelRestCountdown, touchstart: initateRestCountdown, touchend: cancelRestCountdown}">Cancel</button>
    </div>

    <script id="player-template" type="text/html">
        <div>
            <button data-bind="text: $data, visible: $data != '{add new}', disable: $root.isPicked($data), click: function(){$root.pick($data)}"></button>
            <button data-bind="visible: $data == '{add new}', click: $root.queryForUser"><u>Add Player</u></button>
        </div>
    </script>

    <div id="player-list" data-bind="visible: isPicking, template: {name: 'player-template', foreach: playersSorted}"></div>

    <div data-bind="foreach: stats">
        <div><label data-bind="text: label"></label>: <span data-bind="text:team"></span>, <span data-bind="text:player"></span></div>
    </div>

    </div>

    <script type="text/javascript">
        function Elo(initScore, x10diff, kFactor) {
            this.initScore = initScore || 800;
            this.x10diff = x10diff || 400;
            this.kFactor = kFactor || 32;
        }

        Elo.prototype.expectWin = function (a, b) {
            return 1 / (1 + Math.pow(10, ((b.score || this.initScore) - (a.score || this.initScore)) / this.x10diff));
        }

        Elo.prototype.update = function (winner, looser, tie) {
            var expecta = this.expectWin(winner, looser);
            var expectb = this.expectWin(looser, winner);

            this.updatePlayer(winner, expecta, tie ? .5 : 1);
            this.updatePlayer(looser, expectb, tie ? .5 : 0);
        }

        Elo.prototype.updatePlayer = function (a, expected, scoreForA) {
            var delta = this.kFactor * (scoreForA - expected);

            a.score = Math.max(0, (a.score || this.initScore) + delta);
            a.numMatches = (a.numMatches || 0) + 1;
            a.numWins = (a.numWins || 0) + (scoreForA == 1);
        }
    </script>

    <script type="text/javascript">
        var dbgTeams;

        function KickerModel() {
            var $ = this;

            $.windowTitle = ko.observable('Elo Rating Tracker');

            var teams = localStorage.getItem('kicker-teams');
            teams = (teams && JSON.parse(teams)) || [];

            var players = teams.reduce(function (plyrs, team) {
                function tryAdd(plyr) {
                    if (plyrs.indexOf(plyr) == -1)
                        plyrs.push(plyr);
                }

                tryAdd(team.team.defence);
                tryAdd(team.team.offence);

                return plyrs;
            }, 'Vova T; Vova G; Sergii K; Sergii S; Dmytro; Andriy; Almaz; Anton'.split('; '));

            $.players = ko.observableArray(players);
            $.playersSorted = ko.computed(function () {
                var sorted = $.players.slice().sort(sortCI);
                return sorted.concat('{add new}');
            });

            $.pickStatus = ko.observable('Red Defence');
            $.picks = {
                red: {
                    defence: ko.observable('---'),
                    offence: ko.observable('---'),
                    team: ko.observable(null)
                },
                blue: {
                    defence: ko.observable('---'),
                    offence: ko.observable('---'),
                    team: ko.observable(null)
                }
            };

            $.redScore = ko.computed(getScore($.picks.red.team));
            $.blueScore = ko.computed(getScore($.picks.blue.team));

            function getScore(team) {
                return function () {
                    var t = team();

                    return t == null || t.score === undefined
                        ? ''
                        : t.score.toFixed(0);
                }
            }

            $.queryForUser = function () {
                var name = prompt("Enter new player name").trim();

                if (name != '' && !$.players().some(function (p) { return p == name })) {
                    $.players.push(name)
                    $.pick(name);
                }
            }

            $.pick = function (player) {
                if ($.isPicked(player))
                    return;

                var status = $.pickStatus();
                switch (status) {
                    case 'Red Defence': $.picks.red.defence(player);
                        $.pickStatus('Red Offence');
                        break;
                    case 'Red Offence': $.picks.red.offence(player);
                        $.pickStatus('Blue Offence');
                        break;
                    case 'Blue Offence': $.picks.blue.offence(player);
                        $.pickStatus('Blue Defence');
                        break;
                    case 'Blue Defence': $.picks.blue.defence(player);
                        $.pickStatus('Ready');
                        break;
                }

                if ($.pickStatus() == "Ready") {
                    pullExpected();
                }
            }

            $.winRed = function () { win('red', 'blue') }
            $.winBlue = function () { win('blue', 'red') }

            $.reset = function () {
                $.pickStatus('Red Defence');

                $.expectRed('');
                $.expectBlue('');

                $.picks.red.defence('---');
                $.picks.red.offence('---');
                $.picks.red.team(null);

                $.picks.blue.defence('---');
                $.picks.blue.offence('---');
                $.picks.blue.team(null);
            }

            teamsUpdate = ko.observable();

            function win(winner, looser) {
                var won = $.picks[winner].team();
                var lost = $.picks[looser].team();

                elo.update(won, lost);

                // trigger stats update
                teamsUpdate(teamsUpdate() + 1);
                localStorage.setItem('kicker-teams', JSON.stringify($.teams()));

                $.reset()
            }

            var resetTimer = null;
            $.initateRestCountdown = function () {
                resetTimer = setTimeout(initiateReset, 5000);
            }

            $.cancelRestCountdown = function () {
                clearTimeout(resetTimer)
            }

            function initiateReset() {
                if (confirm('Are you sure you want to reset statistics?'))
                    reset();
            }

            function reset() {
                localStorage.clear();
                document.location.reload();
            }

            $.expectRed = ko.observable('');
            $.expectBlue = ko.observable('');

            $.teams = ko.observableArray(teams);
            var elo = new Elo();

            function pullExpected() {
                var red = findTeam($.picks.red.defence(), $.picks.red.offence());
                var blue = findTeam($.picks.blue.defence(), $.picks.blue.offence());

                $.expectRed((elo.expectWin(red, blue) * 100).toFixed(0) + '%');
                $.expectBlue((elo.expectWin(blue, red) * 100).toFixed(0) + '%');

                $.picks.red.team(red);
                $.picks.blue.team(blue);
            }

            function findTeam(defence, offence) {
                var teams = $.teams();

                var team = null;

                // search for exact match
                for (var i = 0; i < teams.length; ++i) {
                    var item = teams[i];
                    if (item.team.offence == offence && item.team.defence == defence) {
                        return item;
                    }
                }

                // search for reverse match
                for (var i = 0; i < teams.length; ++i) {
                    var item = teams[i];
                    if (item.team.offence == defence && item.team.defence == offence) {
                        team = { team: { offence: offence, defence: defence }, score: item.score };
                        $.teams.push(team);
                        return team;
                    }
                }

                // search score by players average score is similar teams
                var score1 = findScore(defence, 'defence', 'offence', teams), score2 = findScore(offence, 'offence', 'defence', teams);

                if (score1 > 0 && score2 > 0) {
                    team = { team: { offence: offence, defence: defence }, score: (score1 + score2) / 2 };
                    $.teams.push(team);

                    return team;
                }

                // if nothing found create new
                if (team == null) {
                    team = { team: { offence: offence, defence: defence } }
                    $.teams.push(team);

                    return team;
                }

                return team;
            }

            function findScore(player, role1, role2, teams) {
                function sum(acc, team) {
                    return acc + team.team.score;
                }

                var match = teams.filter(function (team) { return team[role1] == player });

                if (match.length > 0)
                    return match.reduce(sum, 0) / match.length;

                match = teams.filter(function (team) { return team[role2] == player });

                if (match.length > 0)
                    return match.reduce(sum, 0) / match.length;

                return 0;
            }

            $.isPicking = ko.computed(function () { var status = $.pickStatus(); return 'Offence;Defence'.split(';').some(function (word) { return status.indexOf(word) > -1 }) });

            $.isPicked = function (player) {

                var v = $.isPicking()
                    && ($.picks.red.defence() == player || $.picks.red.offence() == player || $.picks.blue.defence() == player || $.picks.blue.offence() == player);

                return v;
            }

            $.stats = ko.computed(function () {
                function stat(label, team, player) {
                    return {
                        label: label,
                        team: team === undefined ? 'n/a' : team.defence + "(d)+" + team.offence + "(o) - " + team.score.toFixed(0),
                        player: player.player + ' - ' + player.score.toFixed(0)
                    };
                }

                function pickTeam(sortBy, reverse) {
                    var sorted = $.teams.slice();
                    sorted.sort(function (a, b) { var cmp = sortBy(a) - sortBy(b); return reverse ? - cmp : cmp });
                    return sorted[0] && {
                        offence: sorted[0].team.offence,
                        defence: sorted[0].team.defence,
                        score: sortBy(sorted[0]) || NaN
                    };
                }

                function pickPlayer(sortBy, reverse) {
                    var obj = $.teams().reduce(function (acc, team) {
                        function upd(player) {
                            var record = acc[player] || { scores: [] };
                            record.scores.push(sortBy(team));

                            acc[player] = record;
                        }

                        upd(team.team.defence);
                        upd(team.team.offence);

                        return acc;
                    }, {});

                    var players = []

                    for (var i in obj) {
                        players.push([i, obj[i].scores.reduce(sum) / obj[i].scores.length]);
                    }

                    var top = players.sort(function (a, b) { return reverse ? b[1] - a[1] : a[1] - b[1] })[0];

                    return top === undefined ? { player: 'n/a', score: NaN } : { player: top[0], score: top[1] };
                }

                var dummy = teamsUpdate();
                return [
                    { label: "total", team: $.teams().length + ' teams', player: $.teams().reduce(function (sum, team) { return sum + team.numMatches }, 0) / 2 + ' games' },
                    stat('highest rating', pickTeam(teamScore, true), pickPlayer(teamScore, true)),
                    stat('lowest rating', pickTeam(teamScore, false), pickPlayer(teamScore, false)),
                    stat('most games', pickTeam(matches, true), pickPlayer(matches, true)),
                    stat('most wins', pickTeam(numWins, true), pickPlayer(numWins, true)),
                    stat('most losses', pickTeam(numLosses, true), pickPlayer(numLosses, true)),

                ];
            });
        }

        ko.applyBindings(new KickerModel(), document.getElementById('doc'));

        function sortCI(a, b) { return a.toLowerCase() > b.toLowerCase() ? 1 : -1; }
        function sum(acc, s) { return acc + (s || 0) }

        function matches(team) { return team.numMatches || 0 }
        function teamScore(team) { return team.score || 0 }
        function numWins(team) { return team.numWins || 0 }
        function numLosses(team) { return (team.numMatches - team.numWins) || 0 }
    </script>

</body>

</html>