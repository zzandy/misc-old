<!DOCTYPE html>

<html id="doc" lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title data-bind="text: windowTitle">Elo Rating tracker</title>
    <style type="text/css">
        html,
        body,
        button {
            font-size: 1cm;
            background-color: black;
            color: grey;
        }

        .picker {
            border-radius: .3em;
        }

        .picker table {
            border-collapse: collapse;
        }

        #player-list {
            column-count: 2;
            text-align: center;
            transition: all 1s ease-out;
        }

        #player-list button {
            font-size: 150%;
            margin: .3em 0;
        }

        button {
            font-size: 120%;
            min-width: 7em;
            padding: .5em 1em;
            margin: .1em;
            border-color: hsla(0, 0%, 50%, .7);
            border-radius: .3em;
            background-color: hsla(0, 0%, 1%, .1);
            color: hsla(0, 100%, 100%, .8);
        }

        button:disabled {
            color: hsla(0, 0%, 50%, .3);
            border-color: hsla(0, 0%, 50%, .2);
        }

        .picker td,
        .picker th {
            padding: .1em .5em;
            min-height: 1em;
        }

        .red {
            text-align: left;
            background-color: hsla(0, 100%, 35%, 1);
            color: hsla(0, 100%, 85%, 1);
        }

        .blue {
            text-align: right;
            background-color: hsla(215, 100%, 40%, 1);
            color: hsla(215, 100%, 85%, 1);
        }

        .det-stats table:not(:last-child) {
            margin-bottom: 1em;
        }

        .det-stats td:not(:last-child) {
            padding-right: .5em;
        }

        .det-stats .number {
            text-align: right
        }
        .det-stats .text {
            white-space: nowrap
        }
    </style>
    <script type="text/javascript" src="knockout.js"></script>

</head>

<body>
    <div class="picker">
        <table style="width: 100%">
            <tr>
                <th class="red" colspan="2">Red</th>
                <th class="blue" colspan="2">Blue</th>
            </tr>
            <tr>
                <th class="red">Defence</th>
                <th class="red">Offence</th>
                <th class="blue">Offence</th>
                <th class="blue">Defence</th>
            </tr>
            <tr>
                <td class="red" data-bind="text: picks.red.defence"></td>
                <td class="red" data-bind="text: picks.red.offence"></td>
                <td class="blue" data-bind="text: picks.blue.offence"></td>
                <td class="blue" data-bind="text: picks.blue.defence"></td>
            </tr>
            <tr>
                <td class="red"><button data-bind="click: winRed, disable: isPicking">Win</button></td>
                <td class="red" data-bind="text: expectRed"></td>
                <td class="blue" data-bind="text: expectBlue"></td>
                <td class="blue"><button data-bind="click: winBlue, disable: isPicking">Win</button></td>
            </tr>
        </table>
    </div>

    <div style="align-content: center">
        <button style="display: block; margin-left: auto; margin-right: auto; width: 5em" data-bind="click: reset, disable:pickStatus()=='Red Defence', event: {mousedown: initateRestCountdown, mouseup: cancelRestCountdown, touchstart: initateRestCountdown, touchend: cancelRestCountdown}">Cancel</button>
    </div>

    <script id="player-template" type="text/html">
        <div>
            <button data-bind="text: $data, visible: $data != '{add new}', disable: $root.isPicked($data), click: function(){$root.pick($data)}"></button>
            <button data-bind="visible: $data == '{add new}', click: $root.queryForUser"><u>Add Player</u></button>
        </div>
    </script>

    <div id="player-list" data-bind="visible: isPicking, template: {name: 'player-template', foreach: playersSorted}"></div>

    <div data-bind="foreach: stats">
        <div><label data-bind="text: label"></label>: <span data-bind="text:team"></span>, <span data-bind="text:player"></span></div>
    </div>

    <button data-bind="click: showStats, text: isStatsShown() ? 'Less stats' : 'More stats'"></button>

    <script id="stats-template" type="text/html">
        <table>
            <thead>
                <tr data-bind="foreach: columns">
                    <!-- ko if: $index() == 0 -->
                    <th>#</th>
                    <!-- /ko -->
                    <th data-bind="text: title + '&nbsp;' + ind(), click: toggle">Name</th>
                </tr>
            </thead>
            <tbody data-bind="template: {name: 'stat-line-template', foreach: rows}"></tbody>
        </table>
    </script>

    <script id="stat-line-template" type="text/html">
        <tr data-bind="foreach: [$index()+1].concat(data)">
            <td data-bind="text: $data, css: $parent.className[$index()-1]"></td>
        </tr>
    </script>

    <div class="det-stats" data-bind="visible: isStatsShown, template: {name: 'stats-template', foreach: detailedStats}" />

    <script type="text/javascript">
        function Elo(initScore, x10diff, kFactor) {
            this.initScore = initScore || 800;
            this.x10diff = x10diff || 400;
            this.kFactor = kFactor || 32;
        }

        Elo.prototype.expectWin = function (a, b) {
            return 1 / (1 + Math.pow(10, ((b.score || this.initScore) - (a.score || this.initScore)) / this.x10diff));
        }

        Elo.prototype.update = function (winner, looser, tie) {
            var expecta = this.expectWin(winner, looser);
            var expectb = this.expectWin(looser, winner);

            this.updatePlayer(winner, expecta, tie ? .5 : 1);
            this.updatePlayer(looser, expectb, tie ? .5 : 0);
        }

        Elo.prototype.updatePlayer = function (a, expected, scoreForA) {
            var delta = this.kFactor * (scoreForA - expected);

            a.score = Math.max(0, (a.score || this.initScore) + delta);
            a.numMatches = (a.numMatches || 0) + 1;
            a.numWins = (a.numWins || 0) + (scoreForA == 1);
        }
    </script>

    <script type="text/javascript">
        var dbgTeams;

        function KickerModel() {
            var $ = this;

            $.windowTitle = ko.observable('Elo Rating Tracker');

            var teams = localStorage.getItem('kicker-teams');
            teams = (teams && JSON.parse(teams)) || [];

            var players = teams.reduce(function (plyrs, team) {
                function tryAdd(plyr) {
                    if (plyrs.indexOf(plyr) == -1)
                        plyrs.push(plyr);
                }

                tryAdd(team.team.defence);
                tryAdd(team.team.offence);

                return plyrs;
            }, 'Vova T; Vova G; Sergii K; Sergii S; Dmytro; Andriy; Almaz; Anton'.split('; '));

            $.players = ko.observableArray(players);
            $.playersSorted = ko.computed(function () {
                var sorted = $.players.slice().sort(sortCI);
                return sorted.concat('{add new}');
            });

            var noPick = '---';

            $.pickStatus = ko.observable('Red Defence');
            $.picks = {
                red: {
                    defence: ko.observable(noPick),
                    offence: ko.observable(noPick),
                    team: ko.observable(null)
                },
                blue: {
                    defence: ko.observable(noPick),
                    offence: ko.observable(noPick),
                    team: ko.observable(null)
                }
            };

            $.redScore = ko.computed(getScore($.picks.red.team));
            $.blueScore = ko.computed(getScore($.picks.blue.team));

            function getScore(team) {
                return function () {
                    var t = team();

                    return t == null || t.score === undefined
                        ? ''
                        : t.score.toFixed(0);
                }
            }

            $.queryForUser = function () {
                var name = prompt("Enter new player name").trim();

                if (name != '' && !$.players().some(function (p) { return p == name })) {
                    $.players.push(name)
                    $.pick(name);
                }
            }

            $.pick = function (player) {
                if ($.isPicked(player))
                    return;

                var status = $.pickStatus();
                switch (status) {
                    case 'Red Defence': $.picks.red.defence(player);
                        $.pickStatus('Red Offence');
                        break;
                    case 'Red Offence': $.picks.red.offence(player);
                        $.pickStatus('Blue Offence');
                        break;
                    case 'Blue Offence': $.picks.blue.offence(player);
                        $.pickStatus('Blue Defence');
                        break;
                    case 'Blue Defence': $.picks.blue.defence(player);
                        $.pickStatus('Ready');
                        break;
                }

                if ($.picks.red.defence() != noPick
                    && $.picks.red.offence() != noPick
                    && $.picks.blue.defence() != noPick
                    && $.picks.blue.offence() != noPick) {
                    pullExpected();
                    $.pickStatus('Ready');
                }
            }

            $.winRed = function () { win('red', 'blue') }
            $.winBlue = function () { win('blue', 'red') }

            var winStreakTeam = null;
            var winStreak = 0;

            $.reset = function () {
                winTeam = null;
                winStreak = 0;

                $.pickStatus('Red Defence');

                $.expectRed('');
                $.expectBlue('');

                $.picks.red.defence('---');
                $.picks.red.offence('---');
                $.picks.red.team(null);

                $.picks.blue.defence('---');
                $.picks.blue.offence('---');
                $.picks.blue.team(null);
            }

            teamsUpdate = ko.observable();

            function win(winner, looser) {
                var won = $.picks[winner].team();
                var lost = $.picks[looser].team();

                if (won == winStreakTeam)
                    winStreak += 1;
                else {
                    winStreak = 1;
                    winStreakTeam = won;
                }

                if (winStreak < 3) {
                    $.expectRed('');
                    $.expectBlue('');

                    $.picks[winner].defence(won.team.defence);
                    $.picks[winner].offence(won.team.offence);
                    $.picks[winner].team(won);

                    $.picks[looser].defence(lost.team.offence);
                    $.picks[looser].offence(noPick);
                    $.picks[looser].team(null);

                    $.pickStatus(winner == 'red' ? 'Blue Offence' : 'Red Offence');
                }
                else {
                    $.expectRed('');
                    $.expectBlue('');

                    $.picks[winner].defence(won.team.defence);
                    $.picks[winner].offence(noPick);
                    $.picks[winner].team(null);

                    $.picks[looser].defence(lost.team.offence);
                    $.picks[looser].offence(won.team.offence);
                    $.picks[looser].team(findTeam(lost.team.offence, won.team.offence));

                    $.pickStatus(winner == 'blue' ? 'Blue Offence' : 'Red Offence');
                }

                elo.update(won, lost);

                // trigger stats update
                teamsUpdate(teamsUpdate() + 1);
                localStorage.setItem('kicker-teams', JSON.stringify($.teams()));
            }

            var resetTimer = null;
            var clickTimer = null;
            var click = false;
            $.initateRestCountdown = function () {
                resetTimer = setTimeout(initiateReset, 5000);

                click = true;
                clickTimer = setTimeout(cancelClick, 100);
            }

            function cancelClick() {
                click = false;
            }

            $.cancelRestCountdown = function () {
                clearTimeout(resetTimer)
                clearTimeout(clickTimer);

                if (click) {
                    $.reset()
                }
            }

            function initiateReset() {
                if (confirm('Are you sure you want to reset statistics?'))
                    reset();
            }

            function reset() {
                localStorage.clear();
                document.location.reload();
            }

            $.expectRed = ko.observable('');
            $.expectBlue = ko.observable('');

            $.teams = ko.observableArray(teams);
            var elo = new Elo();

            function pullExpected() {
                var red = findTeam($.picks.red.defence(), $.picks.red.offence());
                var blue = findTeam($.picks.blue.defence(), $.picks.blue.offence());

                $.expectRed((elo.expectWin(red, blue) * 100).toFixed(0) + '%');
                $.expectBlue((elo.expectWin(blue, red) * 100).toFixed(0) + '%');

                $.picks.red.team(red);
                $.picks.blue.team(blue);
            }

            function findTeam(defence, offence) {
                var teams = $.teams();

                var team = null;

                // search for exact match
                for (var i = 0; i < teams.length; ++i) {
                    var item = teams[i];
                    if (item.team.offence == offence && item.team.defence == defence) {
                        return item;
                    }
                }

                // search for reverse match
                for (var i = 0; i < teams.length; ++i) {
                    var item = teams[i];
                    if (item.team.offence == defence && item.team.defence == offence) {
                        team = { team: { offence: offence, defence: defence }, score: item.score };
                        $.teams.push(team);
                        return team;
                    }
                }

                // search score by players average score is similar teams
                var score1 = findScore(defence, 'defence', 'offence', teams), score2 = findScore(offence, 'offence', 'defence', teams);

                if (score1 > 0 && score2 > 0) {
                    team = { team: { offence: offence, defence: defence }, score: (score1 + score2) / 2 };
                    $.teams.push(team);

                    return team;
                }

                // if nothing found create new
                if (team == null) {
                    team = { team: { offence: offence, defence: defence } }
                    $.teams.push(team);

                    return team;
                }

                return team;
            }

            function findScore(player, role1, role2, teams) {
                function sum(acc, team) {
                    return acc + team.team.score;
                }

                var match = teams.filter(function (team) { return team[role1] == player });

                if (match.length > 0)
                    return match.reduce(sum, 0) / match.length;

                match = teams.filter(function (team) { return team[role2] == player });

                if (match.length > 0)
                    return match.reduce(sum, 0) / match.length;

                return 0;
            }

            $.isPicking = ko.computed(function () { var status = $.pickStatus(); return 'Offence;Defence'.split(';').some(function (word) { return status.indexOf(word) > -1 }) });

            $.isPicked = function (player) {

                var v = $.isPicking()
                    && ($.picks.red.defence() == player || $.picks.red.offence() == player || $.picks.blue.defence() == player || $.picks.blue.offence() == player);

                return v;
            }

            $.stats = ko.computed(function () {
                function stat(label, team, player) {
                    return {
                        label: label,
                        team: team === undefined ? 'n/a' : team.defence + "(d)+" + team.offence + "(o) - " + team.score.toFixed(0),
                        player: player.player + ' - ' + player.score.toFixed(0)
                    };
                }

                function pickTeam(sortBy, reverse, skip) {
                    skip = skip || 0;
                    var sorted = $.teams.slice().filter(notNan(sortBy));

                    sorted.sort(function (a, b) { var cmp = (sortBy(a) || 0) - (sortBy(b) || 0); return reverse ? - cmp : cmp });

                    return sorted[0 + skip] && {
                        offence: sorted[0 + skip].team.offence,
                        defence: sorted[0 + skip].team.defence,
                        score: sortBy(sorted[0 + skip]) || NaN
                    };
                }

                function pickPlayer(sortBy, reverse, total, skip) {
                    skip = skip || 0;
                    var obj = $.teams().reduce(function (acc, team) {
                        function upd(player) {
                            var record = acc[player] || { scores: [] };
                            var val = sortBy(team);

                            if (val) {
                                record.scores.push(val);
                                acc[player] = record;
                            }
                        }

                        upd(team.team.defence);
                        upd(team.team.offence);

                        return acc;
                    }, {});

                    var players = []

                    for (var i in obj) {
                        var scores = obj[i].scores
                        players.push([i, scores.reduce(max) / 10000 + (total ? scores.reduce(sum) : scores.reduce(sum) / scores.length)]);
                    }

                    var top = players.sort(function (a, b) { return reverse ? b[1] - a[1] : a[1] - b[1] })[0 + skip];

                    return top === undefined ? { player: 'n/a', score: NaN } : { player: top[0], score: top[1] };
                }

                var dummy = teamsUpdate();
                return [
                    { label: "total", team: $.teams().length + ' teams', player: $.teams().filter(function (team) { return 'numMatches' in team }).reduce(function (sum, team) { return sum + team.numMatches }, 0) / 2 + ' games' },
                    stat('highest rating', pickTeam(teamScore, true), pickPlayer(teamScore, true, false)),
                    stat('2nd highest', pickTeam(teamScore, true, 1), pickPlayer(teamScore, true, false, 1)),
                    stat('3rd highest', pickTeam(teamScore, true, 2), pickPlayer(teamScore, true, false, 2)),
                    stat('lowest rating', pickTeam(teamScore, false), pickPlayer(teamScore, false)),
                    stat('most games', pickTeam(matches, true), pickPlayer(matches, true, true)),
                    stat('least games', pickTeam(matches, false), pickPlayer(matches, false, true)),
                    stat('most wins', pickTeam(numWins, true), pickPlayer(numWins, true, true)),
                    stat('most losses', pickTeam(numLosses, true), pickPlayer(numLosses, true, true)),
                ];
            });

            var teamStats = [['defence;Defence', defence], ['offence;Offence', offence], ['score;Rank', teamScore2], ['wins;Wins', numWins], ['losses;Losses', numLosses], ['ratio;Wins%', ratio, percent], ['games;Games', matches]];
            var playerStats = [['name;Name', name],
            ['max;Max Rank', maxRank], ['maxd; (d)', maxRankd], ['maxd;(o)', maxRanko],
            ['avg;Average Rank', avgRank], ['avgd;(d)', avgRankd], ['avgo;(o)', avgRanko],
            ['wins;Wins', numWins], ['losses;Losses', numLosses],
            ['ratio;Wins%', ratio, percent], ['ratiod;(d)', ratiod, percent], ['ratiod;(o)', ratioo, percent],
            ['games;Games', matches]
            ];

            var up = '\u25b2'; // ▲
            var down = '\u25bc'; // ▼
            var none = '\u00a0\u00a0\u00a0';

            teamStats = teamStats.map(parseStats);
            playerStats = playerStats.map(parseStats)

            teamStats.forEach(addSort);
            playerStats.forEach(addSort);

            function isText(name) { return name == 'defence' || name == 'offence' || name == 'name' }

            function isDefault(name) { return name == 'score' || name == 'max' }

            function parseStats(stat) {
                var name = stat[0].split(';');
                var ind = ko.observable(isDefault(name[0]) ? down : none);

                return { name: name[0], title: name[1], fetch: stat[1], ind: ind, toggle: null, formatter: stat[2] || null, className: isText(name[0]) ? 'text' : 'number' }
            }

            function addSort(stat, i, a) {
                stat.toggle = function () {
                    var order = stat.ind();
                    a.forEach(function (other) { other.ind(none) });
                    stat.ind(order == down ? up : (isText(stat.name) && order == none) ? up : down);
                }
            }

            $.detailedStats = ko.computed(function () {
                var dummy = $.teamsUpdate;

                var teamData = $.teams().map(fetchTeamStats);
                teamData.sort(byTeamStats);

                var playerData = $.teams().reduce(fetchPlayerData, [{}]).reduce(unwrap, []).map(fetchPlayerStats);

                playerData.sort(byPlayerStats);

                var teams = { columns: teamStats, rows: teamData };
                var players = { columns: playerStats, rows: playerData }
                return [teams, players];
            });

            function fetchTeamStats(team) {
                return teamStats.reduce(function (data, stat) {
                    data[stat.name] = stat.fetch(team);
                    data.data.push(stat.formatter ? stat.formatter(data[stat.name]) : data[stat.name]);
                    data.className.push(stat.className);
                    return data;
                }, { data: [], className: [] });
            }

            function byTeamStats(teama, teamb) {
                var stat = teamStats.filter(function (stat) { return stat.ind() != none })[0];
                return stat ? (stat.ind() == up ? cmp(teama[stat.name], teamb[stat.name]) : -cmp(teama[stat.name], teamb[stat.name]))
                    : 0;
            }

            function updatePlayerAspect(team, player) {
                (player.scores || (player.scores = [])).push(team.score);
                player.numMatches = (player.numMatches || 0) + team.numMatches;
                player.numWins = (player.numWins || 0) + team.numWins;
            }

            function updatePlayer(team, player, scope) {
                updatePlayerAspect(team, player)
                updatePlayerAspect(team, player[scope] || (player[scope] = {}));
            }

            function fetchPlayerData(acc, team) {
                var obj = acc[0];

                var defence = team.team.defence in obj ? obj[team.team.defence] : obj[team.team.defence] = {};
                var offence = team.team.offence in obj ? obj[team.team.offence] : obj[team.team.offence] = {};

                updatePlayer(team, defence, 'defence')
                updatePlayer(team, offence, 'offence')

                return acc;
            }

            function unwrap(acc, playerData) {
                for (var i in playerData) { playerData[i].name = i; acc.push(playerData[i]) }
                return acc;
            }

            function fetchPlayerStats(player) {
                return playerStats.reduce(function (data, stat) {
                    data[stat.name] = stat.fetch(player);
                    data.data.push(stat.formatter ? stat.formatter(data[stat.name]) : data[stat.name]);
                    data.className.push(stat.className);
                    return data;
                }, { data: [], className: [] });
            }

            function byPlayerStats(p1, p2) {
                var stat = playerStats.filter(function (stat) { return stat.ind() != none })[0];

                return stat ? (stat.ind() == up ? cmp(p1[stat.name], p2[stat.name]) : -cmp(p1[stat.name], p2[stat.name]))
                    : 0;
            }

            $.isStatsShown = ko.observable(false);

            $.showStats = function () {
                $.isStatsShown(!$.isStatsShown());
            }
        }

        ko.applyBindings(new KickerModel(), document.getElementById('doc'));

        function sortCI(a, b) { return a.toLowerCase() > b.toLowerCase() ? 1 : -1; }
        function sum(acc, s) { return acc + (s || 0) }
        function max(acc, s) { return Math.max(acc, s || -Infinity) }
        function cmp(a, b) { return a > b ? 1 : a == b ? 0 : -1 }

        function matches(team) { return team.numMatches }
        function teamScore(team) { return team.score }
        function teamScore2(team) { return team.score.toFixed(0) }
        function defence(team) { return team.team.defence }
        function offence(team) { return team.team.offence }
        function numWins(team) { return team.numWins }
        function numLosses(team) { return team.numMatches - team.numWins }
        function name(player) { return player.name }

        function maxRank(p) { return p.scores.reduce(max).toFixed(0) }
        function maxRankd(p) { return p.defence && maxRank(p.defence) || 'n/a' }
        function maxRanko(p) { return p.offence && maxRank(p.offence) || 'n/a' }


        function avgRank(p) { return (p.scores.reduce(sum) / p.scores.length).toFixed(0) }
        function avgRankd(p) { return p.defence && avgRank(p.defence) || 'n/a' }
        function avgRanko(p) { return p.offence && avgRank(p.offence) || 'n/a' }

        function ratiod(p) { return p.defence && ratio(p.defence) || 'n/a' }
        function ratioo(p) { return p.offence && ratio(p.offence) || 'n/a' }

        function ratio(team) { return (team.numMatches == 0 ? 0 : team.numWins / team.numMatches) }
        function percent(v) { return isNaN(v) ? 'n/a' : (v * 100).toFixed(0) + "%" }

        function notNan(getter) {
            return function (i) {
                return !isNaN(getter(i));
            }
        }
    </script>

</body>

</html>