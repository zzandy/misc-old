<!DOCTYPE html>

<html id="doc" lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>Games</title>
    <meta charset="utf-8" />
    <link rel="icon" sizes="32x32" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMTZEaa/1AAADBUlEQVRYR62XS08aURTH+RikH8adpkm3NG660MR0YeKiq8Y1rRhZmPQTNDFdmiZNY9yYtpoKtJI+wCqFmgAaRREIw3Nm4PSey1y4cznMXIgn+Ykc4P8/9zH3EQCAIR8CgSAjzEgxLAb4EXh6ooPFSDHCjKDsKZuHGIYsroNjMA0GI+QqgAmhOWlA8T0UgruDA/i5skIZ6MKLEN0+Vcv7lsV+C9DrdilhXbAnglgAjjlpNAno93kB+KqITksYC8AJRxpNAluO0et0KNFpSGEBWrNdEFtYgJ5p8gI6NzeU6DRYWABppPJjeRnuj45Ys3vcXETH6sPnU4MS14Myk/m7sQF2u+3YTY7TYps28IMyFfxeXXXk9eLLLD1BGQtahYIjDWDV685/3lGqWbTRJChj5OvcHBfs2zacLC7y3PDxUwLTbXM0N8qGBbFMA55EsrSpjGos+Le9zcVK+/vDXCuf5zkqXr67hHShBT1WjM3+XJS6kMg2aFMZ2VSmuLPDhbEnRC63tcVzVOzGq7SBH7KpTCUehz575NQ8NQwWazEproNqIKjEYmBWq2N5yzAcW3d8TNZoAz9UAwEut81cbizvNRFJAz9UA0Fpbw+M8/OxPA4LFaY94zCoBn7YjYZj6Y57w6YN/KBMvMhubjqW7sB1gDTwgzLxo3x46NiOgpoDj57/guPMYNLiK75XvzNTAUg2EoH21RUXx8AFSBUX5iLwvfqdmQtA/qyvg/xMHLPlVxanQv6cQwnrUE0kHMlRqL3w4D1gVirQvb0dnogw8Km8rpr8YIJRro92wwedA7H5eb4zYuAiVUsmIRMOD4VevC3yzzBe7V67Tbxg4tqH0no6zQ3wPiByshhuwRjYG3LeA34ojQoxP3Dc8SQs51TRT+nBweX9N63dMYoFaF9MUmtr0C2XXTlCFM4u23xC5u88Ly6DiwkrFotYkkWnQREd0uwM9ozHryeeipbQmxeAMDEs4sEup8/eXEC1Se4P2HJu7irAKQKHA+eE9sRUxL3A63mUIV3PIfAf8eNsoPz6yjkAAAAASUVORK5CYII=">
    <script type="text/javascript" src="knockout.js"></script>
    <style type="text/css">
        html {
            color: hsl(0, 0%, 60%);
            background-color: black;
        }

        .row {
            display: flex;
            justify-content: space-around;
            margin-bottom: .05rem;
        }

        .row div {
            flex: 1;
        }

        .row div.score {
            flex: .1;
            text-align: center;
        }

        .row div.triple {
            flex: .3;
            text-align: center;
        }

        .row div.nfo {
            flex: .4;
        }

        .dim {
            color: hsl(0, 0%, 40%);
        }

        .red {
            background-color: hsla(0, 100%, 25%, 1);
            color: hsla(0, 100%, 95%, 1);
        }

        .blue {
            background-color: hsla(215, 100%, 25%, 1);
            color: hsla(215, 100%, 95%, 1);
        }

        .red.win {
            background-color: hsla(0, 100%, 35%, 1);
            color: hsla(0, 100%, 95%, 1);
        }

        .blue.win {
            background-color: hsla(215, 100%, 40%, 1);
            color: hsla(215, 100%, 95%, 1);
        }

        .avgrate {
            background-color: hsl(56, 100%, 40%);
            color: hsl(56, 100%, 90%)
        }

        .games {
            background-color: hsl(90, 80%, 40%);
            color: hsl(90, 100%, 90%)
        }

        .wins {
            background-color: hsl(0, 90%, 40%);
            color: hsl(0, 95%, 95%)
        }

        .ratio {
            background-color: hsl(290, 100%, 60%);
            color: hsl(290, 100%, 96%)
        }

        .progress {
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
            height: .1em;
            min-height: .1em;
            background-color: lime;
            box-shadow: 0 0 .2em lime;
        }
    </style>
</head>

<body>
    <input type="text" placeholder="source" data-bind="value: source" />
    <button data-bind="click: refresh, disable: isRefreshing">Refresh</button>
    <input type="checkbox" data-bind="checked: showData" />

    <div data-bind="visible: haveData">

        <div class="row">
            <div class="nfo">Date</div>
            <div class="nfo">Time</div>
            <div class="nfo">Duration</div>
            <div class="red">Defence</div>
            <div class="red">Offence</div>
            <div class="red score"></div>
            <div class="blue score"></div>
            <div class="blue">Offence</div>
            <div class="blue">Defence</div>
        </div>

        <div data-bind="foreach: games">
            <div class="row">
                <div class="nfo" data-bind="text: date"></div>
                <div class="nfo" data-bind="text: time"></div>
                <div class="nfo" data-bind="css: {dim:suspectDuration}, text: duration"></div>
                <div class="red" data-bind="css: {win:redWin}, text: red.defense.firstName + ' ' + red.defense.lastName"></div>
                <div class="red" data-bind="css: {win:redWin}, text: red.offense.firstName + ' ' + red.offense.lastName"></div>
                <div class="red score" data-bind="css: {win:redWin}, text: red.score"></div>
                <div class="blue score" data-bind="css: {win:blueWin}, text: blue.score"></div>
                <div class="blue" data-bind="css: {win:blueWin}, text: blue.offense.firstName + ' ' + blue.offense.lastName"></div>
                <div class="blue" data-bind="css: {win:blueWin}, text: blue.defense.firstName + ' ' + blue.defense.lastName"></div>
            </div>
        </div>

        <div class="row">
            <div>Name</div>
            <div class="triple avgrate">Avg Rating</div>
            <div class="triple games">Games</div>
            <div class="triple wins">Wins</div>
            <div class="triple ratio">Win Rate</div>
        </div>

        <div class="row">
            <div></div>

            <div class="score avgrate">Tot</div>
            <div class="score avgrate">Def</div>
            <div class="score avgrate">Off</div>

            <div class="score games">Tot</div>
            <div class="score games">Def</div>
            <div class="score games">Off</div>

            <div class="score wins">Tot</div>
            <div class="score wins">Def</div>
            <div class="score wins">Off</div>

            <div class="score ratio">Tot</div>
            <div class="score ratio">Def</div>
            <div class="score ratio">Off</div>
        </div>


        <div data-bind="foreach: players">
            <div class="row">
                <div data-bind="text: givenName + ' ' + familyName"></div>

                <div class="score avgrate" data-bind="text: rating.toFixed()"></div>
                <div class="score avgrate" data-bind="text: defense.rating.toFixed()"></div>
                <div class="score avgrate" data-bind="text: offense.rating.toFixed()"></div>

                <div class="score games" data-bind="text: numGames"></div>
                <div class="score games" data-bind="text: defense.numGames"></div>
                <div class="score games" data-bind="text: offense.numGames"></div>

                <div class="score wins" data-bind="text: numWins"></div>
                <div class="score wins" data-bind="text: defense.numWins"></div>
                <div class="score wins" data-bind="text: offense.numWins"></div>

                <div class="score ratio" data-bind="text:(100* winRate).toFixed(0)+'%'"></div>
                <div class="score ratio" data-bind="text: (100*defense.winRate).toFixed(0)+'%'"></div>
                <div class="score ratio" data-bind="text: (100*offense.winRate).toFixed(0)+'%'"></div>
            </div>
        </div>

    </div>

    <div style="margin-bottom: -1em; z-index: 10; position: relative">
        <select data-bind="value: feature, options: features"></select>
        <select data-bind="value: aspect, options: aspects"></select>
    </div>

    <!-- color -->
    <script type="text/javascript">
        // hue Chroma luma
        function hcy2rgb(h, c, y, a) {
            // 601
            var r = .3;
            var g = .59;
            var b = .11;

            var h0 = h;
            h /= 60;

            var k = (1 - Math.abs((h % 2) - 1));

            var K = h < 1 ? r + k * g
                : h < 2 ? g + k * r
                    : h < 3 ? g + k * b
                        : h < 4 ? b + k * g
                            : h < 5 ? b + k * r
                                : r + k * b;

            var cmax = 1;

            if (y <= 0 || y >= 1) cmax = 0;
            else cmax *= K < y ? (y - 1) / (K - 1) : K > y ? y / K : 1;
            //c *= cmax;
            c = Math.min(c, cmax);

            var x = c * k;
            var rgb = h < 1 ? [c, x, 0]
                : h < 2 ? [x, c, 0]
                    : h < 3 ? [0, c, x]
                        : h < 4 ? [0, x, c]
                            : h < 5 ? [x, 0, c]
                                : [c, 0, x];

            var m = y - (r * rgb[0] + g * rgb[1] + b * rgb[2]);

            var rgbdata = [rgb[0] + m, rgb[1] + m, rgb[2] + m];
            return 'rgba(' + (rgbdata[0] * 255).toFixed(0) + ',' + (rgbdata[1] * 255).toFixed(0) + ',' + (rgbdata[2] * 255).toFixed(0) + ', ' + (a || 1) + ')';
        }
    </script>

    <!-- canvas -->
    <script type="text/javascript">
        "use strict";

        function fullscreenCanvas(relative) {

            var c = document.createElement('canvas');
            var ctx = c.getContext('2d');

            ctx.canvas.width = window.innerWidth;
            ctx.canvas.height = window.innerHeight;

            if (!relative) {
                ctx.canvas.style.position = 'absolute';
                ctx.canvas.style.top = 0;
                ctx.canvas.style.left = 0;
            }

            ctx.clear = function () {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            };

            ctx.makePath = function (vertices) {
                this.beginPath();
                this.moveTo(vertices[0], vertices[1]);
                for (var i = 2; i < vertices.length; i += 2) {
                    this.lineTo(vertices[i], vertices[i + 1]);
                }
                this.closePath();
            }

            ctx.strokeCircle = function (x, y, r) {
                ctx.beginPath();
                ctx.arc(x, y, r, 0, 2 * Math.PI, true);
                ctx.closePath();
                ctx.stroke();
            }

            ctx.fillCircle = function (x, y, r) {
                ctx.beginPath();
                ctx.arc(x, y, r, 0, 2 * Math.PI, true);
                ctx.closePath();
                ctx.fill();
            }

            document.body.appendChild(c);
            return ctx;
        }
    </script>

    <!-- Elo -->
    <script type="text/javascript">
        function Elo(initScore, x10diff, kFactor) {
            this.initScore = initScore || 800;
            this.x10diff = x10diff || 400;
            this.kFactor = kFactor || 32;
        }

        Elo.prototype.getNew = function (score, numMatches, numWins) {
            return {
                score: score || this.initScore,
                numMatches: numMatches || 0,
                numWins: numWins || 0
            }
        }

        Elo.prototype.expectWin = function (a, b) {
            return 1 / (1 + Math.pow(10, ((b.score || this.initScore) - (a.score || this.initScore)) / this.x10diff));
        }

        Elo.prototype.game = function (t1, t2, s1, s2) {
            // Expected
            var e1 = this.expectWin(t1, t2);
            var e2 = this.expectWin(t2, t1);

            // Scores to "Results"
            var r1 = s1 > s2 ? 1 : s1 < s2 ? 0 : .5;
            var r2 = s2 > s1 ? 1 : s2 < s1 ? 0 : .5;

            this.updatePlayer(t1, e1, r1);
            this.updatePlayer(t2, e2, r2);
        }

        Elo.prototype.update = function (winner, looser, tie) {
            var expecta = this.expectWin(winner, looser);
            var expectb = this.expectWin(looser, winner);

            this.updatePlayer(winner, expecta, tie ? .5 : 1);
            this.updatePlayer(looser, expectb, tie ? .5 : 0);
        }

        Elo.prototype.updatePlayer = function (a, expected, scoreForA) {
            var delta = this.kFactor * (scoreForA - expected);

            a.score = Math.max(0, (a.score || this.initScore) + delta);
            a.numMatches = (a.numMatches || 0) + 1;
            a.numWins = (a.numWins || 0) + (scoreForA == 1);
        }
    </script>

    <!-- Ajax -->
    <script type="text/javascript">
        "use strict";
        function request(verb, url, data) {
            return new Promise(function (resolve, reject) {
                var http = new XMLHttpRequest();

                http.open(verb, url, true);
                http.setRequestHeader('Content-type', 'application/json; charset=utf-8');

                http.onreadystatechange = function () {
                    if (http.readyState == 4) {
                        if (http.status == 200) {
                            resolve(JSON.parse(http.responseText));
                        }
                        else {
                            reject('POST ' + url + ': ' + http.statusText + '. ' + http.responseText);
                        }
                    }
                }

                if (data)
                    http.send(JSON.stringify(data));
                else http.send(null);
            });
        }

        function postJson(url, data) {
            return request('POST', url, data);
        }

        function getJson(url) {
            return request('GET', url)
        }
    </script>

    <!-- promises -->
    <script type="text/javascript">
        // wrap a function for a promise chain
        function gogo(fn) {
            var args = [].slice.call(arguments, 1);
            return function (a) {
                return fn.apply(null, [a].concat(args));
            }
        }

        // chain promises
        function chain(promise) {
            for (var prom of arguments) {
                if (prom == promise) continue;
                promise = promise.then(prom);
            }

            return promise;
        }
    </script>

    <!-- API -->
    <script type="text/javascript">
        function AlmazApi(baseUrl) {
            var state = { url: baseUrl, players: [] };
            this.scope = Promise.resolve(state).then(refreshPlayers);
        }

        AlmazApi.prototype.getPlayers = function () {
            var self = this;

            return new Promise(function (resolve, reject) {
                self.scope = self.scope.then(function (ctx) { resolve(ctx.players); return ctx; });
            });
        }

        AlmazApi.prototype.getGames = function (source) {
            var self = this;

            return new Promise(function (resolve, reject) {
                self.scope = self.scope.then(function (ctx) {
                    if (!('url' in ctx))
                        throw 'Invalid context';

                    return getJson(ctx.url + (!!source ? 'games?source=' + encodeURIComponent(source) : 'games'))
                        .catch(function (e) { console.error(e); return ctx; })
                        .then(function (data) {
                            resolve(data);
                            return ctx;
                        });

                });
            });
        }

        function refreshPlayers(ctx) {
            return getJson(ctx.url + 'players')
                .then(function (players) { ctx.players = players; return ctx; })
                .catch(function (e) {
                    console.error(e);
                    return ctx;
                });
        }
    </script>

    <!-- Progress -->
    <script type="text/javascript">
        (function () {
            function progress(name, promiseFn) {
                var start = new Date().getTime();

                var bar = showBar();
                var expec = getExpectation(name);

                var update = function () {
                    var now = new Date().getTime();
                    var elapsed = now - start;

                    updateBar(bar, elapsed / expec);

                    window.requestAnimationFrame(update);
                }
                update();

                var done = function () {
                    var end = new Date().getTime();

                    hideBar(bar);
                    saveExpectation(name, end - start);
                    update = function () { };
                }

                promiseFn().then(done).catch(done);
            }

            function showBar() {
                var bar = document.createElement('div');
                bar.className = 'progress';

                document.body.insertBefore(bar, document.body.firstChild);

                return bar;
            }

            function updateBar(bar, ratio) {
                var q = 1;

                var r = Math.min(1, ratio * q);
                bar.style.width = r * 100 + '%';
            }

            function hideBar(bar) {
                bar.parentElement.removeChild(bar);
            }

            function getExpectation(name) {
                var itemName = 'progress-record-' + name;
                var previous = JSON.parse(localStorage.getItem(itemName)) || [];

                var res = previous.length > 0 ? previous.reduce(function (i, b) { return i + b }, 0) / previous.length : NaN;

                return res;
            }

            var maxlen = 5;

            function saveExpectation(name, elapsed) {
                var itemName = 'progress-record-' + name;
                var previous = JSON.parse(localStorage.getItem(itemName)) || [];
                previous.push(elapsed);

                if (previous.length > maxlen)
                    previous = previous.slice(previous.length - maxlen);

                localStorage.setItem(itemName, JSON.stringify(previous))
            }

            this.progress = progress;
        })();
    </script>

    <script type="text/javascript">
        var url = 'https://foosball-results.herokuapp.com/api/';
        var api = new AlmazApi(url);
        var ctx = null;

        var features = 'overall;winrate';
        var prevts = 0;
        var tsadj = 0;

        ko.applyBindings(getModel(api), document.getElementById('doc'));

        Array.prototype.min = function () {
            return this.reduce(function (mx, i) { return Math.min(mx, i); });
        }

        Array.prototype.max = function () {
            return this.reduce(function (mx, i) { return Math.max(mx, i); });
        }

        Array.prototype.avg = function () {
            return this.length > 0 ? this.reduce(function (s, i) { return s + i }) / this.length : NaN;
        }

        function timeseries() {
            var limits = {};
            features.split(';').forEach(function (name) { limits[name] = { x: [Infinity, -Infinity], y: [Infinity, -Infinity], adj: { x: [Infinity, -Infinity] } } });
            return {
                limits: limits,
                xp: [],
                series: []
            }
        }

        function series(obj) {
            return { key: obj, head: { ts: 0, values: {}, next: null } };
        }

        function getModel() {
            var m = {};

            m.games = ko.observableArray([]);
            m.players = ko.observableArray([]);
            m.timeseries = ko.observable([]);

            m.feature = ko.observable('overall');
            m.features = features.split(';');
            m.aspect = ko.observable('any');
            m.aspects = ['any', 'def', 'off'];

            m.showData = ko.observable(false);

            m.haveData = ko.computed(function () {
                return m.showData() && m.games().length > 0;
            });

            m.timeseries.subscribe(function (value) {
                render(value, m.feature(), m.aspect());
            });

            m.feature.subscribe(function (value) {
                m.aspect(m.aspects[0]);
                render(m.timeseries(), value, m.aspect());
            });

            m.aspect.subscribe(function (value) {
                render(m.timeseries(), m.feature(), value);
            });

            m.source = ko.observable(localStorage.getItem('source-of-choice') || '');
            m.isRefreshing = ko.observable(false);

            m.refresh = function () {
                localStorage.setItem('source-of-choice', m.source());
                m.isRefreshing(true);
                progress('refresh', function () {
                    return api.getGames(m.source()).then(updateGames);
                });
            }

            function updateGames(games) {
                var context = { elo: new Elo(), teams: {}, timeseries: timeseries() };

                m.games(games.sort(byEndDate)
                    .filter(removeDuplicates)
                    .forEach(prepareGame(context)));

                m.players(preparePlayers(context.timeseries.series));

                m.timeseries(context.timeseries);
                m.isRefreshing(false);
            }

            m.refresh();

            return m;
        }

        function preparePlayers(series) {
            var players = series.map(preparePlayer);
            players.sort(byRating);
            return players;
        }

        function preparePlayer(ts) {
            return {
                givenName: ts.key.firstName,
                familyName: ts.key.lastName,

                rating: ts.head.values.overall.any,
                numGames: ts.stats.numGames,
                numWins: ts.stats.numWins,
                winRate: ts.head.values.winrate.any / 100,

                defense: {
                    rating: ts.head.values.overall.def,
                    numGames: ts.stats.defense.numGames,
                    numWins: ts.stats.defense.numWins,
                    winRate: ts.head.values.winrate.def / 100,
                },

                offense: {
                    rating: ts.head.values.overall.off,
                    numGames: ts.stats.offense.numGames,
                    numWins: ts.stats.offense.numWins,
                    winRate: ts.head.values.winrate.off / 100,
                }
            }
        }

        function byRating(a, b) {
            return b.rating - a.rating;
        }

        function byEndDate(a, b) {
            return new Date(a.endDate) - new Date(b.endDate);
        }

        function removeDuplicates(game, i, games) {
            return game.red.score != game.blue.score && (i == 0 || !areDuplicate(game, games[i - 1]));
        }

        function areDuplicate(g, f) {
            var dif = Math.abs((new Date(g.endDate)) - (new Date(f.endDate)));

            return dif < 120000 && teamsEqual(g.red, f.red) && teamsEqual(g.blue, f.blue);
        }

        function teamsEqual(t1, t2) {
            return t1.defense._id == t2.defense._id && t1.offense._id == t2.offense._id && t1.score == t2.score;
        }

        function prepareGame(context) {
            return function (game) {
                var eloRed = getEloTeam(context, game.red);
                var eloBlue = getEloTeam(context, game.blue);

                game.rating = {
                    blue: { before: eloBlue.score },
                    red: { before: eloRed.score }
                };

                context.elo.game(eloRed, eloBlue, game.red.score, game.blue.score);

                game.rating.blue.after = eloBlue.score;
                game.rating.red.after = eloRed.score;

                var start = new Date(game.startDate);
                var end = new Date(game.endDate);

                game.redWin = game.red.score > game.blue.score;
                game.blueWin = game.red.score < game.blue.score;

                game.date = end.getFullYear() + '-' + zf(end.getMonth() + 1, 2) + '-' + zf(end.getDate(), 2);
                game.time = zf(end.getHours(), 2) + ':' + zf(end.getMinutes(), 2) + ':' + zf(end.getSeconds(), 2);
                var span = end.getTime() - start.getTime();

                game.suspectDuration = span < 30000 || span > 900000;
                game.duration = span > 15000 && span < 2400000 ? formatTimespan(span) : '';

                logGame(context.timeseries, eloBlue, game, 'offense', game.blueWin);
                logGame(context.timeseries, eloBlue, game, 'defense', game.blueWin);
                logGame(context.timeseries, eloRed, game, 'offense', game.redWin);
                logGame(context.timeseries, eloRed, game, 'defense', game.redWin);

                return game;
            }
        };

        function logGame(timeseries, team, game, role, won) {
            var ts = (new Date(game.endDate)).getTime();
            var cutoff = addDays(getMonday(), -3 * 7).getTime();

            var player = team[role];
            var series = findSeries(timeseries, player);
            var stats = series.stats;

            ++stats.numGames;
            ++stats[role].numGames;

            if (won) {
                ++stats.numWins;
                ++stats[role].numWins;
            }

            stats.ratings.push(team.score);
            stats[role].ratings.push(team.score);

            var values = {
                'overall': {
                    any: stats.ratings.avg(),
                    def: stats.defense.ratings.avg(),
                    off: stats.offense.ratings.avg()
                },
                'winrate': {
                    any: winrate(stats),
                    def: winrate(stats.defense),
                    off: winrate(stats.offense)
                }
            };

            var prev = series.head.ts == 0 ? null : series.head;

            var threshold = 1000 * 60 * 30;
            if (prevts != 0 && ts - prevts > threshold) {
                tsadj += ts - prevts - threshold;
            }

            if (ts >= cutoff && prevts != 0 && new Date(prevts).getDay() != new Date(game.endDate).getDay())
                timeseries.xp.push([ts - tsadj, ts]);

            prevts = ts;

            if (ts >= cutoff)

                for (var limit in timeseries.limits) {
                    expand2(timeseries.limits[limit].y, values[limit]);
                    expand3(timeseries.limits[limit], values[limit], ts, tsadj);
                }

            series.head = { ts: ts, ats: ts - tsadj, values: values, next: prev };
        }

        function expand2(range, triplet) {
            expand(range, triplet.any);
            expand(range, triplet.def);
            expand(range, triplet.off);
        }

        function expand3(limit, triplet, ts, tsadj) {
            if (triplet.all != null || triplet.def != null || triplet.off != null) {
                expand(limit.x, ts);
                expand(limit.adj.x, ts - tsadj);
            }
        }

        function expand(range, value) {
            if (value != null) {
                if (range[0] > value) range[0] = value;
                if (range[1] < value) range[1] = value;
            }
        }

        function winrate(stat) {
            return stat.numGames > 10 ? 100 * (stat.numWins / stat.numGames) : null;
        }

        function findSeries(timeseries, player) {
            var s = timeseries.series.filter(function (ts) { return ts.key._id == player._id })[0];

            if (s == null) {
                s = series(player);
                s.stats = {
                    ratings: [],
                    numGames: 0,
                    numWins: 0,

                    defense: {
                        ratings: [],
                        numGames: 0,
                        numWins: 0
                    },

                    offense: {
                        ratings: [],
                        numGames: 0,
                        numWins: 0
                    }
                };
                timeseries.series.push(s)
            }

            return s;
        }

        function getTeamId(team) {
            return team.offense._id + team.defense._id;
        }

        function getEloTeam(context, team) {
            var id = getTeamId(team);

            if (!(id in context.teams)) {
                context.teams[id] = context.elo.getNew();

                context.teams[id].defense = team.defense;
                context.teams[id].offense = team.offense;
            }

            return context.teams[id];
        }

        function formatTimespan(ts, inclMs) {
            var s = 1000;
            var m = 60 * s;
            var h = 60 * m;
            var d = 24 * h;

            var days = ts / d | 0;
            ts -= days * d;

            var hours = ts / h | 0;
            ts -= hours * h;

            var minutes = ts / m | 0;
            ts -= minutes * m;

            var seconds = ts / s | 0;
            ts -= seconds * s;

            var repr = [zf(hours, 2), zf(minutes, 2), zf(seconds, 2)].join(':')

            if (days > 0) repr = days + '.' + repr;
            if (inclMs) repr = repr + '.' + zf(ts, 3);

            return repr;
        }

        function formatDate(date) {
            var day = 'Sun,Mon,Tue,Wed,Thu,Fri,Sat'.split(',');
            return day[date.getDay()] + ', ' + date.getFullYear() + '-' + zf(date.getMonth() + 1, 2) + '-' + zf(date.getDate(), 2)
        }

        function zf(val, w) {
            val = val.toString();
            if (val.length < w)
                val = new Array(w - val.length + 1).join('0') + val;

            return val;
        }

        function getMonday() {
            var now = new Date();
            var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var monday = addDays(today, -Math.abs(today.getDay() - 1));
            return monday;
        }

        function addDays(date, days) {
            return new Date(date.getTime() + days * 24 * 60 * 60 * 1000);
        }

        function getCutoffDate(days) {
            var now = new Date();
            var then = new Date(now.getTime() + days * 24 * 60 * 60 * 1000);

            var thenDate = new Date(then.getFullYear(), then.getMonth(), then.getDate());

            return thenDate;
        }

        function render(timeseries, feature, aspect) {
            if (ctx == null) {
                ctx = fullscreenCanvas(true);

                ctx.canvas.width -= 30;
                ctx.canvas.height -= 20;
                ctx.canvas.style.zIndex = -100;
            }

            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            var limits = timeseries.limits[feature];

            var maxWidth = 0;

            ctx.font = '12pt Segoe UI'

            for (var series of timeseries.series) {
                var name = series.key.firstName + ' ' + series.key.lastName;
                var w = ctx.measureText(name).width * 2;

                if (maxWidth < w) maxWidth = w;
            }

            var nice = {
                x: niceTime(limits.adj.x),
                y: niceRange(limits.y)
            };

            var fitInto = { x: [30, ctx.canvas.width - w * 1.1], y: [ctx.canvas.height - 30, 0] };

            var scale = scaleFn(nice, fitInto);

            ctx.strokeStyle = 'hsl(0, 0%, 40%)';
            ctx.fillStyle = 'hsl(0, 0%, 80%)'
            ctx.lineWidth = 1;

            ctx.font = '10pt Segoe UI';

            // Draw horizonlal lines
            for (var i = nice.y[0] + 10; i < nice.y[1]; i += 10) {
                var p1 = scale([nice.x[0], i]);
                var p2 = scale([nice.x[1], i]);

                p1[1] = (p1[1] | 0) + .5;
                p2[1] = (p2[1] | 0) + .5;

                line(ctx, p1, p2);
                ctx.fillText(i, 5, p1[1] + 6);
            }

            // Draw vertical lines
            var ci = 0;
            for (var v of timeseries.xp) {
                var p1 = scale([v[0], nice.y[0]]);
                var p2 = scale([v[0], nice.y[1]]);

                p1[0] = (p1[0] | 0) + .5;
                p2[0] = (p2[0] | 0) + .5;

                line(ctx, p1, p2);
                ctx.fillText(formatDate(new Date(v[1])), p1[0], p1[1] + ((++ci) % 3) * 10);
            }

            for (var i = nice.y[0] + 1; i < nice.y[1]; ++i); {
                var d1 = new Date(i - 1);
                var d1 = new Date(i - 1);
            }

            ctx.font = '12pt Segoe UI';

            // Adjust and draw labels
            var ci = 0;
            var labels = [];
            var palette = '#f44336;#3f51b5;#8bc34a;#607d8b;#ff5722;#00bcd4;#e91e63;#00b294;#03a9f4;#ffb900;#107c10'.split(';');
            timeseries.series.sort(function(a,b){
                return a.head.values[feature][aspect]-b.head.values[feature][aspect];
            });

            for (var series of timeseries.series) {
                var name = series.key.firstName + ' ' + series.key.lastName;
                series.color = adjust((60 + (ci) * 360 / (timeseries.series.length + 1)) % 360);
                series.color = palette[ci % palette.length];

                labels[scale([0, series.head.values[feature][aspect]])[1] | 0] = { name: name, adj: 0, color: series.color };
                ci++;
            }

            var overlap = true;
            var retries = 0;
            var height = 16;

            while (retries < 10 && overlap) {
                overlap = false;
                ++retries;

                var last = null;

                for (var label in labels) {
                    if (isNaN(parseInt(label))) continue;

                    if (last == null) {
                        last = label;
                    }
                    else {
                        var p1 = labels[last];
                        var p2 = labels[label];

                        var gap = (parseInt(label) + p2.adj) - (parseInt(last) + p1.adj);

                        if (gap < height) {
                            p1.adj -= (height - gap) / 2;
                            p2.adj += (height - gap) / 2;
                            overlap = true;
                        }

                        last = label;
                    }
                }
            }

            for (var label in labels) {
                if (isNaN(parseInt(label))) continue;
                //ctx.fillStyle = hcy2rgb(labels[label].color, 1, .4, 1);
                ctx.fillStyle = labels[label].color;

                ctx.fillText(labels[label].name, ctx.canvas.width - w, labels[label].adj + parseInt(label));
            }

            function adjust(x) {
                return x;
            }

            for (var series of timeseries.series) {
                var c = series.color;
                ctx.fillStyle = c;//hcy2rgb(c, 1, .5, 1);
                ctx.strokeStyle = c;//hcy2rgb(c, 1, .5, .5);

                ctx.lineWidth = 1;

                var t = series.head.ats;
                var b = series.head.values[feature][aspect];

                var point = series.head.next;

                while (point !== null) {
                    var tn = point.ats;
                    var bn = point.values[feature][aspect];

                    line(ctx, scale([t, b]), scale([tn, bn]));

                    var c = scale([tn, bn]);
                    ctx.fillCircle(c[0], c[1], 2)

                    t = tn;
                    b = bn;

                    point = point.next;
                }
            }
        }

        function poly(ctx, vertices) {
            ctx.beginPath();
            ctx.moveTo(vertices[0][0], vertices[0][1]);
            for (var i = 1; i < vertices.length; ++i)
                ctx.lineTo(vertices[i][0], vertices[i][1]);

            ctx.closePath();
        }

        function line(ctx, p1, p2) {
            ctx.beginPath();
            ctx.moveTo(p1[0], p1[1]);
            ctx.lineTo(p2[0], p2[1]);
            ctx.stroke();
        }

        function scaleFn(world, canvas) {
            var ws = canvas.x[1] - canvas.x[0];
            var ww = world.x[1] - world.x[0];

            var hs = canvas.y[1] - canvas.y[0];
            var hw = world.y[1] - world.y[0];

            var sx = ws / ww;
            var sy = hs / hw;

            return function (coords) {
                var wx = coords[0] - world.x[0];
                var wy = coords[1] - world.y[0];

                return [canvas.x[0] + sx * wx, canvas.y[0] + sy * wy];
            }
        }

        function niceRange(r) {
            var range = r[1] - r[0];
            return [(Math.round(r[0] / 10)) * 10, (Math.round(r[1] / 10)) * 10];
        }

        function niceTime(r, cutoff) {
            return r;
        }
    </script>
</body>

</html>