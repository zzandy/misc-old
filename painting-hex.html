<!DOCTYPE html>
<html>
<head>
</head>
<body>
    <script type="text/javascript">
        "use strict";
        
        function makeLoop(fixedDelta, fixedUpdate, update){
            var acc = 0;

            return function(delta){
                if(delta === undefined || isNaN(delta)){
                    delta = fixedDelta;
                }
                
                acc += delta;
                
                while(acc>=fixedDelta){
                    fixedUpdate(fixedDelta);
                    acc -= fixedDelta;
                }
                update(delta);
            }
        }
        
        function loop(loopFunction, sheduleFunction){

            var then;
            var iteration = function(){
                var now = new Date().getTime();
                var delta = now - then;
                then = now;
                
                loopFunction(delta);
                
                sheduleFunction(iteration);
            }
            
            iteration();
        }
    </script>

    <script type="text/javascript">
        "use strict";

        function fullscreenCanvas() {

            var c = document.createElement('canvas');
            var ctx = c.getContext('2d');

            ctx.canvas.width = window.innerWidth;
            ctx.canvas.height = window.innerHeight;
            ctx.canvas.style.position = 'absolute';
            ctx.canvas.style.top = 0;
            ctx.canvas.style.left = 0;
            
            ctx.clear = function(){
                ctx.clearRect(-ctx.canvas.width/2, -ctx.canvas.height/2, ctx.canvas.width, ctx.canvas.height);
            };

            var q = 1 / Math.sqrt(3);
            
            ctx.getHexPath = function(h){
                var dx = q * h / 2;
                var dy = h / 2;

                return [2 * dx, 0
                        ,dx, -dy
                        ,-dx, -dy
                        ,-2 * dx, 0
                        ,-dx, dy
                        ,dx, dy];
            }
            
            ctx.makePath = function(vertices){
                this.beginPath();
                this.moveTo(vertices[0], vertices[1]);
                for(var i=2;i<vertices.length;i+=2){
                    this.lineTo(vertices[i], vertices[i+1]);
                }
                this.closePath();
            }

            ctx.pathHex = function (h) {
                this.makePath(this.getHexPath(h));
            };

            ctx.fillHex = function (x, y, h) {
                this.save();
                this.translate(x, y);
                this.pathHex(h);
                this.fill();
                this.restore();
            };

            ctx.strokeHex = function (x, y, a) {
                this.save();
                this.translate(x, y);
                this.pathHex(a);
                this.stroke();
                this.restore();
            };

            ctx.translate(ctx.canvas.width / 2, ctx.canvas.height / 2);
            ctx.scale(1, -1);
            document.body.appendChild(c);
            return ctx;
        }
    </script>
    <script type="text/javascript">
        "use strict";

        var ctx = fullscreenCanvas();
        var a = 0;

        var w = 30;
        var h = 20;
        var data = array(20, 30, function(i, j){ return {value:Math.random() < .5 }});
        var s = new Pos(10, 10);
        var o = getHexPos(h/2, w/2);
        o = new Pos(-o.x*s.x, -o.y*s.y);
        var ready = false;
        var updated = true;
        var renderer = null;

        loadImageData('hex-pieces.png')
            .then(parseStencilTemplates)
            .then(constructStencils)
            .then(renderSprites)
            .then(setReady);

        function parseStencilTemplates(data){
            return {
                stencil1:  [[0, 0, 0, 1, 1, 1, 1, 0, 0, 0],
                            [0, 0, 1, 1, 1, 1, 1, 2, 2, 2],
                            [0, 1, 1, 2, 2, 2, 2, 2, 2, 2],
                            [2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
                            [0, 2, 2, 2, 2, 2, 2, 2, 2, 0],
                            [0, 0, 2, 2, 2, 2, 2, 2, 2, 0],
                            [0, 0, 0, 2, 2, 2, 2, 2, 2, 0],
                            [0, 0, 0, 0, 0, 2, 2, 2, 2, 0],
                            [0, 0, 0, 0, 0, 0, 2, 2, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 2, 0, 0]],
                stencil2: [[0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 2, 1, 1, 0, 0, 0, 0, 0],
                            [0, 0, 2, 2, 1, 1, 1, 1, 0, 0],
                            [0, 0, 2, 2, 2, 1, 1, 1, 0, 0],
                            [0, 2, 2, 2, 2, 2, 2, 1, 1, 0],
                            [0, 2, 2, 2, 2, 2, 2, 2, 1, 0],
                            [0, 2, 2, 2, 2, 2, 2, 2, 2, 0],
                            [0, 2, 2, 2, 2, 2, 2, 2, 2, 2],
                            [2, 2, 2, 2, 2, 2, 2, 0, 0, 0],
                            [2, 2, 2, 0, 0, 0, 0, 0, 0, 0]],
                stencil3: [[0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0],
                            [0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 1, 0],
                            [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 0],
                            [0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 0],
                            [0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1],
                            [0, 0, 0, 2, 2, 2, 2, 2, 2, 1, 1, 1],
                            [0, 0, 0, 0, 0, 2, 2, 2, 2, 1, 1, 0],
                            [0, 0, 0, 0, 0, 0, 2, 2, 2, 1, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]]
            };

            return {
                stencil1: slice( 0, data.height, data.width, 10, data.data),
                stencil2: slice(10, data.height, data.width, 10, data.data),
                stencil3: slice(20, data.height, data.width, 12, data.data)
            }
        }


/* hex:  0
        ___
    5  /   \  1
    4  \___/  2
         3           */ 

function present(a){return '[[' + a.map(function(r){return r.join(', ')}).join('],\n [') + ']]'};

        function constructStencils(templates){

            return new Renderer( 4,
                /* sector 5-0 corner */ stencil(0,4,templates.stencil1, 1),
                /* sector 5-0 body   */ stencil(0,4,templates.stencil1, 2),

                /* sector 0-1 corner */ stencil(0,12,templates.stencil2, 1),
                /* sector 0-1 body   */ stencil(0,12,templates.stencil2, 2),

                /* sector 1-2 corner */ stencil(8,12,templates.stencil3, 1),
                /* sector 1-2 body   */ stencil(8,12,templates.stencil3, 2),

                /* sector 2-3 corner */ stencil(11, 10, flip(templates.stencil1), 1),
                /* sector 2-3 body   */ stencil(11, 10, flip(templates.stencil1), 2),

                /* sector 3-4 corner */ stencil(11, 2, flip(templates.stencil2), 1),
                /* sector 3-4 body   */ stencil(11, 2, flip(templates.stencil2), 2),

                /* sector 4-5 corner */ stencil(3, 0, flip(templates.stencil3), 1),
                /* sector 4-5 body   */ stencil(3, 0, flip(templates.stencil3), 2)
            );
        }

        function stencil(oi, oj, s, v){
            return array(21, 24, function(i, j){
                i -= oi;
                j -= oj;

                return i>=0&&j>=0&&i<s.length&&j<s[i].length ? s[i][j] == v : false;

                return s[i][j] == v;
            });
        }

        function flip(stencil){
            return array(stencil.length, stencil[0].length, function(i, j){
                return stencil[stencil.length-1-i][stencil[0].length -1 -j];
            });
        }

        function renderSprites(renderer){
            for(var i=0;i<data.length;++i)
            for(var j=0;j<data[i].length;++j){
                var v = data[i][j].value;
                data[i][j].sprite = renderer.render(v, getN(0, i, j, data), getN(1, i, j, data), getN(2, i, j, data), getN(3, i, j, data), getN(4, i, j, data), getN(5, i, j, data));
            }

            return renderer;
        }

        function setReady(r){
            renderer = r;
            ready = true;
        }
        
        loop(makeLoop(1000/60, fixedUpdate, update), window.requestAnimationFrame);

        function fixedUpdate(delta){
            a += 1;
        }

        function update(delta){
            if(!ready || !updated)
                return;

            ctx.clear();

            ctx.save();

            render(delta);

            ctx.restore();

            updated = false;
        }

        function render(delta)
        {
            //ctx.rotate(a/1000);

            for(var i=0;i<data.length;++i){
                for(var j=0;j<data[i].length;++j){
                    renderCell(i, j, data[i][j], data);
                }
            }
        }

        function renderCell(i, j, cell, data){
            ctx.beginPath();

            var v = cell.value;
            var pos = getHexPos(i, j);

            var imagedata = cell.sprite;
            ctx.putImageData(imagedata, o.x + pos.x   * renderer.scale, o.y+pos.y*  renderer.scale);
            return;

            ctx.arc(o.x + pos.x * s.x, o.y+pos.y*s.y, s.x/2*(.2+v*.8), 0, 2*Math.PI);
            ctx.closePath();

            ctx.fillStyle = 'hsl('+(pos.x+10*pos.y)%360+', 100%, 50%)';

            ctx.fill();
        }

        // Get neighbour
        function getN(n, i, j, data){
            var ni = i+(n == 0 ? -1 : n == 3 ? 1 :  i);
            var nj = j+(n==1||n==2?1:n==4||n==5?-1:0);

            if((n == 1||n==5 )&& j%2 == 0) ni-=1;
            if((n==2||n==4) && j%2 == 1) ni+=1;
            
            return ni>=0&&nj>=0&&ni<data.length&&nj<data[ni].length?data[ni][nj]:null;
        }

        function getHexPos(i, j){
            var q = Math.sqrt(3) / 2;
            
            return new Pos(j*q, i-(j%2)/2);
        }

        function Pos(x, y){
            this.x = x;
            this.y = y;
        }

        function array(rows, cols, gen){
            var res = [];
            for(var i=0;i<rows;++i){
                var row = [];
                for(var j=0;j<cols;++j)
                    row.push(gen(i,j));
                res.push(row);
            }
            return res;
        }

        function loadImageData(url){
            return new Promise(function(resolve, reject){
                resolve(null);
                return;

                var img = new Image();
                
                img.onload = function(){
                    var c = document.createElement('canvas');
                    c.width = this.naturalWidth;
                    c.height = this.naturalHeight;

                    var ctx = c.getContext('2d');
                    ctx.drawImage(this, 0, 0);
                    
                    resolve(ctx.getImageData(0,0,c.width,c.height));
                }

                img.src = url;
            });
        }

        function slice(skipCols, fullHeight, fullWidth, width, data){
            return array(fullHeight, width, function(i, j){
                var index =  (i*fullWidth + (skipCols + j))*4;

                var r = data[index];
                var g = data[index+1];
                var b = data[index+2];
                var a = data[index+3];

                return r == 255 ? 2 : r==0 ? 0 : 1;
            });
        }

        function Renderer(s, s50c, s50b, s01c, s01b, s12c, s12b, s23c, s23b, s34c, s34b, s45c, s45b){
            this.scale = s;
            this.s50 = s50c;
            this.s01 = s01c;
            this.s12 = s12c;
            this.s23 = s23c;
            this.s34 = s34c;
            this.s45 = s45c;
            this.body = array(21, 24, function(i,j){return s50b[i][j]||s01b[i][j]||s12b[i][j]||s23b[i][j]||s34b[i][j]||s45b[i][j]});
        }

        Renderer.prototype.render = function(v, n0, n1, n2, n3, n4, n5){
            var id = ctx.createImageData(24*this.scale, 21*this.scale);
            var data = id.data;
            this.scale=1;
            
            for(var i=0;i<21;++i)
            {
                for(var j=0;j<24;++j)
                {
                    for(var si=0;si<this.scale;++si)
                    {
                        for(var sj=0;sj<this.scale;++sj){
                            var index = ((i*this.scale + si) * 24 + j*this.scale + sj)*4;

                            var set = this.isSet(v, i, j, n0, n1, n2, n3, n4, n5);
                            data[index] = data[index+1] = data[index+2] = set ? 0 : 180;
                            data[index+3] = 1;
                            data[index] = 0; 
                        }
                    }
                }
            }

            return id;
        }

        Renderer.prototype.isSet = function(v, i, j, n0, n1, n2, n3, n4, n5){

            return (v && this.body[i][j])
                || (n0 && (this.s01[i][j] || this.s50[i][j]))
                || (n1 && (this.s01[i][j] || this.s12[i][j]))
                || (n2 && (this.s12[i][j] || this.s23[i][j]))
                || (n3 && (this.s23[i][j] || this.s34[i][j]))
                || (n4 && (this.s34[i][j] || this.s45[i][j]))
                || (n5 && (this.s45[i][j] || this.s50[i][j]));
        }

    </script>
</body>
</html>
